<!doctype html><html lang="en">
 <head>
  <meta content="text/html; charset=utf-8" http-equiv="Content-Type">
  <meta content="width=device-width, initial-scale=1, shrink-to-fit=no" name="viewport">
  <title>Open Screen Network Protocol</title>
  <meta content="ED" name="w3c-status">
  <link href="https://www.w3.org/StyleSheets/TR/2021/W3C-ED" rel="stylesheet">
  <meta content="Bikeshed version 9a7a6709a, updated Tue May 27 16:45:34 2025 -0700" name="generator">
  <link href="https://w3c.github.io/openscreenprotocol/network.html" rel="canonical">
  <meta content="84c3e07ab6acd85cff2a37681a3efe2d7f473d83" name="revision">
  <meta content="dark light" name="color-scheme">
  <link href="https://www.w3.org/StyleSheets/TR/2021/dark.css" media="(prefers-color-scheme: dark)" rel="stylesheet" type="text/css">
<style>
.highlight .hll { background-color: #ffffcc }
.highlight .c { color: #999988; font-style: italic } /* Comment */
.highlight .err { color: #a61717; background-color: #e3d2d2 } /* Error */
.highlight .k { color: #000000; font-weight: bold } /* Keyword */
.highlight .o { color: #000000; font-weight: bold } /* Operator */
.highlight .cm { color: #999988; font-style: italic } /* Comment.Multiline */
.highlight .cp { color: #999999; font-weight: bold; font-style: italic } /* Comment.Preproc */
.highlight .c1 { color: #999988; font-style: italic } /* Comment.Single */
.highlight .cs { color: #999999; font-weight: bold; font-style: italic } /* Comment.Special */
.highlight .gd { color: #000000; background-color: #ffdddd } /* Generic.Deleted */
.highlight .ge { color: #000000; font-style: italic } /* Generic.Emph */
.highlight .gr { color: #aa0000 } /* Generic.Error */
.highlight .gh { color: #999999 } /* Generic.Heading */
.highlight .gi { color: #000000; background-color: #ddffdd } /* Generic.Inserted */
.highlight .go { color: #888888 } /* Generic.Output */
.highlight .gp { color: #555555 } /* Generic.Prompt */
.highlight .gs { font-weight: bold } /* Generic.Strong */
.highlight .gu { color: #aaaaaa } /* Generic.Subheading */
.highlight .gt { color: #aa0000 } /* Generic.Traceback */
.highlight .kc { color: #000000; font-weight: bold } /* Keyword.Constant */
.highlight .kd { color: #000000; font-weight: bold } /* Keyword.Declaration */
.highlight .kn { color: #000000; font-weight: bold } /* Keyword.Namespace */
.highlight .kp { color: #000000; font-weight: bold } /* Keyword.Pseudo */
.highlight .kr { color: #000000; font-weight: bold } /* Keyword.Reserved */
.highlight .kt { color: #445588; font-weight: bold } /* Keyword.Type */
.highlight .m { color: #009999 } /* Literal.Number */
.highlight .s { color: #d01040 } /* Literal.String */
.highlight .na { color: #008080 } /* Name.Attribute */
.highlight .nb { color: #0086B3 } /* Name.Builtin */
.highlight .nc { color: #445588; font-weight: bold } /* Name.Class */
.highlight .no { color: #008080 } /* Name.Constant */
.highlight .nd { color: #3c5d5d; font-weight: bold } /* Name.Decorator */
.highlight .ni { color: #800080 } /* Name.Entity */
.highlight .ne { color: #990000; font-weight: bold } /* Name.Exception */
.highlight .nf { color: #990000; font-weight: bold } /* Name.Function */
.highlight .nl { color: #990000; font-weight: bold } /* Name.Label */
.highlight .nn { color: #555555 } /* Name.Namespace */
.highlight .nt { color: #000080 } /* Name.Tag */
.highlight .nv { color: #008080 } /* Name.Variable */
.highlight .ow { color: #000000; font-weight: bold } /* Operator.Word */
.highlight .w { color: #bbbbbb } /* Text.Whitespace */
.highlight .mf { color: #009999 } /* Literal.Number.Float */
.highlight .mh { color: #009999 } /* Literal.Number.Hex */
.highlight .mi { color: #009999 } /* Literal.Number.Integer */
.highlight .mo { color: #009999 } /* Literal.Number.Oct */
.highlight .sb { color: #d01040 } /* Literal.String.Backtick */
.highlight .sc { color: #d01040 } /* Literal.String.Char */
.highlight .sd { color: #d01040 } /* Literal.String.Doc */
.highlight .s2 { color: #d01040 } /* Literal.String.Double */
.highlight .se { color: #d01040 } /* Literal.String.Escape */
.highlight .sh { color: #d01040 } /* Literal.String.Heredoc */
.highlight .si { color: #d01040 } /* Literal.String.Interpol */
.highlight .sx { color: #d01040 } /* Literal.String.Other */
.highlight .sr { color: #009926 } /* Literal.String.Regex */
.highlight .s1 { color: #d01040 } /* Literal.String.Single */
.highlight .ss { color: #990073 } /* Literal.String.Symbol */
.highlight .bp { color: #999999 } /* Name.Builtin.Pseudo */
.highlight .vc { color: #008080 } /* Name.Variable.Class */
.highlight .vg { color: #008080 } /* Name.Variable.Global */
.highlight .vi { color: #008080 } /* Name.Variable.Instance */
.highlight .il { color: #009999 } /* Literal.Number.Integer.Long */
</style>
<style>/* Boilerplate: style-autolinks */
.css.css, .property.property, .descriptor.descriptor {
    color: var(--a-normal-text);
    font-size: inherit;
    font-family: inherit;
}
.css::before, .property::before, .descriptor::before {
    content: "‘";
}
.css::after, .property::after, .descriptor::after {
    content: "’";
}
.property, .descriptor {
    /* Don't wrap property and descriptor names */
    white-space: nowrap;
}
.type { /* CSS value <type> */
    font-style: italic;
}
pre .property::before, pre .property::after {
    content: "";
}
[data-link-type="property"]::before,
[data-link-type="propdesc"]::before,
[data-link-type="descriptor"]::before,
[data-link-type="value"]::before,
[data-link-type="function"]::before,
[data-link-type="at-rule"]::before,
[data-link-type="selector"]::before,
[data-link-type="maybe"]::before {
    content: "‘";
}
[data-link-type="property"]::after,
[data-link-type="propdesc"]::after,
[data-link-type="descriptor"]::after,
[data-link-type="value"]::after,
[data-link-type="function"]::after,
[data-link-type="at-rule"]::after,
[data-link-type="selector"]::after,
[data-link-type="maybe"]::after {
    content: "’";
}

[data-link-type].production::before,
[data-link-type].production::after,
.prod [data-link-type]::before,
.prod [data-link-type]::after {
    content: "";
}

[data-link-type=element],
[data-link-type=element-attr] {
    font-family: Menlo, Consolas, "DejaVu Sans Mono", monospace;
    font-size: .9em;
}
[data-link-type=element]::before { content: "<" }
[data-link-type=element]::after  { content: ">" }

[data-link-type=biblio] {
    white-space: pre;
}

@media (prefers-color-scheme: dark) {
    :root {
        --selflink-text: black;
        --selflink-bg: silver;
        --selflink-hover-text: white;
    }
}
</style>
<style>/* Boilerplate: style-colors */
/* Any --*-text not paired with a --*-bg is assumed to have a transparent bg */
:root {
    color-scheme: light dark;

    --text: black;
    --bg: white;

    --unofficial-watermark: url(https://www.w3.org/StyleSheets/TR/2016/logos/UD-watermark);

    --logo-bg: #1a5e9a;
    --logo-active-bg: #c00;
    --logo-text: white;

    --tocnav-normal-text: #707070;
    --tocnav-normal-bg: var(--bg);
    --tocnav-hover-text: var(--tocnav-normal-text);
    --tocnav-hover-bg: #f8f8f8;
    --tocnav-active-text: #c00;
    --tocnav-active-bg: var(--tocnav-normal-bg);

    --tocsidebar-text: var(--text);
    --tocsidebar-bg: #f7f8f9;
    --tocsidebar-shadow: rgba(0,0,0,.1);
    --tocsidebar-heading-text: hsla(203,20%,40%,.7);

    --toclink-text: var(--text);
    --toclink-underline: #3980b5;
    --toclink-visited-text: var(--toclink-text);
    --toclink-visited-underline: #054572;

    --heading-text: #005a9c;

    --hr-text: var(--text);

    --algo-border: #def;

    --del-text: red;
    --del-bg: transparent;
    --ins-text: #080;
    --ins-bg: transparent;

    --a-normal-text: #034575;
    --a-normal-underline: #bbb;
    --a-visited-text: var(--a-normal-text);
    --a-visited-underline: #707070;
    --a-hover-bg: rgba(75%, 75%, 75%, .25);
    --a-active-text: #c00;
    --a-active-underline: #c00;

    --blockquote-border: silver;
    --blockquote-bg: transparent;
    --blockquote-text: currentcolor;

    --issue-border: #e05252;
    --issue-bg: #fbe9e9;
    --issue-text: var(--text);
    --issueheading-text: #831616;

    --example-border: #e0cb52;
    --example-bg: #fcfaee;
    --example-text: var(--text);
    --exampleheading-text: #574b0f;

    --note-border: #52e052;
    --note-bg: #e9fbe9;
    --note-text: var(--text);
    --noteheading-text: hsl(120, 70%, 30%);
    --notesummary-underline: silver;

    --assertion-border: #aaa;
    --assertion-bg: #eee;
    --assertion-text: black;

    --advisement-border: orange;
    --advisement-bg: #fec;
    --advisement-text: var(--text);
    --advisementheading-text: #b35f00;

    --warning-border: red;
    --warning-bg: hsla(40,100%,50%,0.95);
    --warning-text: var(--text);

    --amendment-border: #330099;
    --amendment-bg: #F5F0FF;
    --amendment-text: var(--text);
    --amendmentheading-text: #220066;

    --def-border: #8ccbf2;
    --def-bg: #def;
    --def-text: var(--text);
    --defrow-border: #bbd7e9;

    --datacell-border: silver;

    --indexinfo-text: #707070;

    --indextable-hover-text: black;
    --indextable-hover-bg: #f7f8f9;

    --outdatedspec-bg: rgba(0, 0, 0, .5);
    --outdatedspec-text: black;
    --outdated-bg: maroon;
    --outdated-text: white;
    --outdated-shadow: red;

    --editedrec-bg: darkorange;
}

@media (prefers-color-scheme: dark) {
    :root {
        --text: #ddd;
        --bg: black;

        --unofficial-watermark: url("data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' width='400' height='400'%3E%3Cg fill='%23100808' transform='translate(200 200) rotate(-45) translate(-200 -200)' stroke='%23100808' stroke-width='3'%3E%3Ctext x='50%25' y='220' style='font: bold 70px sans-serif; text-anchor: middle; letter-spacing: 6px;'%3EUNOFFICIAL%3C/text%3E%3Ctext x='50%25' y='305' style='font: bold 70px sans-serif; text-anchor: middle; letter-spacing: 6px;'%3EDRAFT%3C/text%3E%3C/g%3E%3C/svg%3E");

        --logo-bg: #1a5e9a;
        --logo-active-bg: #c00;
        --logo-text: white;

        --tocnav-normal-text: #999;
        --tocnav-normal-bg: var(--bg);
        --tocnav-hover-text: var(--tocnav-normal-text);
        --tocnav-hover-bg: #080808;
        --tocnav-active-text: #f44;
        --tocnav-active-bg: var(--tocnav-normal-bg);

        --tocsidebar-text: var(--text);
        --tocsidebar-bg: #080808;
        --tocsidebar-shadow: rgba(255,255,255,.1);
        --tocsidebar-heading-text: hsla(203,20%,40%,.7);

        --toclink-text: var(--text);
        --toclink-underline: #6af;
        --toclink-visited-text: var(--toclink-text);
        --toclink-visited-underline: #054572;

        --heading-text: #8af;

        --hr-text: var(--text);

        --algo-border: #456;

        --del-text: #f44;
        --del-bg: transparent;
        --ins-text: #4a4;
        --ins-bg: transparent;

        --a-normal-text: #6af;
        --a-normal-underline: #555;
        --a-visited-text: var(--a-normal-text);
        --a-visited-underline: var(--a-normal-underline);
        --a-hover-bg: rgba(25%, 25%, 25%, .2);
        --a-active-text: #f44;
        --a-active-underline: var(--a-active-text);

        --borderedblock-bg: rgba(255, 255, 255, .05);

        --blockquote-border: silver;
        --blockquote-bg: var(--borderedblock-bg);
        --blockquote-text: currentcolor;

        --issue-border: #e05252;
        --issue-bg: var(--borderedblock-bg);
        --issue-text: var(--text);
        --issueheading-text: hsl(0deg, 70%, 70%);

        --example-border: hsl(50deg, 90%, 60%);
        --example-bg: var(--borderedblock-bg);
        --example-text: var(--text);
        --exampleheading-text: hsl(50deg, 70%, 70%);

        --note-border: hsl(120deg, 100%, 35%);
        --note-bg: var(--borderedblock-bg);
        --note-text: var(--text);
        --noteheading-text: hsl(120, 70%, 70%);
        --notesummary-underline: silver;

        --assertion-border: #444;
        --assertion-bg: var(--borderedblock-bg);
        --assertion-text: var(--text);

        --advisement-border: orange;
        --advisement-bg: #222218;
        --advisement-text: var(--text);
        --advisementheading-text: #f84;

        --warning-border: red;
        --warning-bg: hsla(40,100%,20%,0.95);
        --warning-text: var(--text);

        --amendment-border: #330099;
        --amendment-bg: #080010;
        --amendment-text: var(--text);
        --amendmentheading-text: #cc00ff;

        --def-border: #8ccbf2;
        --def-bg: #080818;
        --def-text: var(--text);
        --defrow-border: #136;

        --datacell-border: silver;

        --indexinfo-text: #aaa;

        --indextable-hover-text: var(--text);
        --indextable-hover-bg: #181818;

        --outdatedspec-bg: rgba(255, 255, 255, .5);
        --outdatedspec-text: black;
        --outdated-bg: maroon;
        --outdated-text: white;
        --outdated-shadow: red;

        --editedrec-bg: darkorange;
    }
    /* In case a transparent-bg image doesn't expect to be on a dark bg,
       which is quite common in practice... */
    img { background: white; }
}
</style>
<style>/* Boilerplate: style-counters */
body {
    counter-reset: example figure issue;
}
.issue {
    counter-increment: issue;
}
.issue:not(.no-marker)::before {
    content: "Issue " counter(issue);
}

.example {
    counter-increment: example;
}
.example:not(.no-marker)::before {
    content: "Example " counter(example);
}
.invalid.example:not(.no-marker)::before,
.illegal.example:not(.no-marker)::before {
    content: "Invalid Example" counter(example);
}

figcaption {
    counter-increment: figure;
}
figcaption:not(.no-marker)::before {
    content: "Figure " counter(figure) " ";
}
</style>
<style>/* Boilerplate: style-dfn-panel */
:root {
    --dfnpanel-bg: #ddd;
    --dfnpanel-text: var(--text);
    --dfnpanel-target-bg: #ffc;
    --dfnpanel-target-outline: orange;
}
@media (prefers-color-scheme: dark) {
    :root {
        --dfnpanel-bg: #222;
        --dfnpanel-text: var(--text);
        --dfnpanel-target-bg: #333;
        --dfnpanel-target-outline: silver;
    }
}
.dfn-panel {
    position: absolute;
    z-index: 35;
    width: 20em;
    width: 300px;
    height: auto;
    max-height: 500px;
    overflow: auto;
    padding: 0.5em 0.75em;
    font: small Helvetica Neue, sans-serif, Droid Sans Fallback;
    background: var(--dfnpanel-bg);
    color: var(--dfnpanel-text);
    border: outset 0.2em;
    white-space: normal; /* in case it's moved into a pre */
}
.dfn-panel:not(.on) { display: none; }
.dfn-panel * { margin: 0; padding: 0; text-indent: 0; }
.dfn-panel > b { display: block; }
.dfn-panel a { color: var(--dfnpanel-text); }
.dfn-panel a:not(:hover) { text-decoration: none !important; border-bottom: none !important; }
.dfn-panel a:focus {
    outline: 5px auto Highlight;
    outline: 5px auto -webkit-focus-ring-color;
}
.dfn-panel > b + b { margin-top: 0.25em; }
.dfn-panel ul { padding: 0 0 0 1em; list-style: none; }
.dfn-panel li a {
    max-width: calc(300px - 1.5em - 1em);
    overflow: hidden;
    text-overflow: ellipsis;
}

.dfn-panel.activated {
    display: inline-block;
    position: fixed;
    left: 8px;
    bottom: 2em;
    margin: 0 auto;
    max-width: calc(100vw - 1.5em - .4em - .5em);
    max-height: 30vh;
    transition: left 1s ease-out, bottom 1s ease-out;
}

.dfn-panel .link-item:hover {
    text-decoration: underline;
}
.dfn-panel .link-item .copy-icon {
    opacity: 0;
}
.dfn-panel .link-item:hover .copy-icon,
.dfn-panel .link-item .copy-icon:focus {
    opacity: 1;
}

.dfn-panel .copy-icon {
    display: inline-block;
    margin-right: 0.5em;
    width: 0.85em;
    height: 1em;
    border-radius: 3px;
    background-color: #ccc;
    cursor: pointer;
}

.dfn-panel .copy-icon .icon {
    width: 100%;
    height: 100%;
    background-color: #fff;
    display: flex;
    justify-content: center;
    align-items: center;
    position: relative;
}

.dfn-panel .copy-icon .icon::before {
    content: "";
    position: absolute;
    top: 0;
    left: 0;
    width: 100%;
    height: 100%;
    border: 1px solid black;
    background-color: #ccc;
    opacity: 0.25;
    transform: translate(3px, -3px);
}

.dfn-panel .copy-icon:active .icon::before {
    opacity: 1;
}

.dfn-paneled[role="button"] { cursor: help; }

.highlighted {
    animation: target-fade 3s;
}

@keyframes target-fade {
    from {
        background-color: var(--dfnpanel-target-bg);
        outline: 5px solid var(--dfnpanel-target-outline);
    }
    to {
        color: var(--a-normal-text);
        background-color: transparent;
        outline: transparent;
    }
}
</style>
<style>/* Boilerplate: style-issues */
a[href].issue-return {
    float: right;
    float: inline-end;
    color: var(--issueheading-text);
    font-weight: bold;
    text-decoration: none;
}
</style>
<style>/* Boilerplate: style-md-lists */
/* This is a weird hack for me not yet following the commonmark spec
   regarding paragraph and lists. */
[data-md] > :first-child {
    margin-top: 0;
}
[data-md] > :last-child {
    margin-bottom: 0;
}
</style>
<style>/* Boilerplate: style-ref-hints */
:root {
    --ref-hint-bg: #ddd;
    --ref-hint-text: var(--text);
}
@media (prefers-color-scheme: dark) {
    :root {
        --ref-hint-bg: #222;
        --ref-hint-text: var(--text);
    }
}

.ref-hint {
    display: inline-block;
    position: absolute;
    z-index: 35;
    width: 20em;
    width: 300px;
    height: auto;
    max-height: 500px;
    overflow: auto;
    padding: 0.5em 0.5em;
    font: small Helvetica Neue, sans-serif, Droid Sans Fallback;
    background: var(--ref-hint-bg);
    color: var(--ref-hint-text);
    border: outset 0.2em;
    white-space: normal; /* in case it's moved into a pre */
}

.ref-hint * { margin: 0; padding: 0; text-indent: 0; }

.ref-hint ul { padding: 0 0 0 1em; list-style: none; }
</style>
<style>/* Boilerplate: style-selflinks */
:root {
    --selflink-text: white;
    --selflink-bg: gray;
    --selflink-hover-text: black;
}
.heading, .issue, .note, .example, li, dt {
    position: relative;
}
a.self-link {
    position: absolute;
    top: 0;
    left: calc(-1 * (3.5rem - 26px));
    width: calc(3.5rem - 26px);
    height: 2em;
    text-align: center;
    border: none;
    transition: opacity .2s;
    opacity: .5;
}
a.self-link:hover {
    opacity: 1;
}
.heading > a.self-link {
    font-size: 83%;
}
.example > a.self-link,
.note > a.self-link,
.issue > a.self-link {
    /* These blocks are overflow:auto, so positioning outside
       doesn't work. */
    left: auto;
    right: 0;
}
li > a.self-link {
    left: calc(-1 * (3.5rem - 26px) - 2em);
}
dfn > a.self-link {
    top: auto;
    left: auto;
    opacity: 0;
    width: 1.5em;
    height: 1.5em;
    background: var(--selflink-bg);
    color: var(--selflink-text);
    font-style: normal;
    transition: opacity .2s, background-color .2s, color .2s;
}
dfn:hover > a.self-link {
    opacity: 1;
}
dfn > a.self-link:hover {
    color: var(--selflink-hover-text);
}

a.self-link::before            { content: "¶"; }
.heading > a.self-link::before { content: "§"; }
dfn > a.self-link::before      { content: "#"; }
</style>
 <body class="h-entry">
  <div class="head">
   <p data-fill-with="logo"><a class="logo" href="https://www.w3.org/"> <img alt="W3C" height="48" src="https://www.w3.org/StyleSheets/TR/2021/logos/W3C" width="72"> </a> </p>
   <h1 class="p-name no-ref" id="title">Open Screen Network Protocol</h1>
   <p id="w3c-state"><a href="https://www.w3.org/standards/types/#ED">Editor’s Draft</a>, <time class="dt-updated" datetime="2025-06-09">9 June 2025</time></p>
   <details open>
    <summary>More details about this document</summary>
    <div data-fill-with="spec-metadata">
     <dl>
      <dt>This version:
      <dd><a class="u-url" href="https://w3c.github.io/openscreenprotocol/network.html">https://w3c.github.io/openscreenprotocol/network.html</a>
      <dt>Latest published version:
      <dd><a href="https://www.w3.org/TR/openscreen-network/">https://www.w3.org/TR/openscreen-network/</a>
      <dt>Feedback:
      <dd><a href="https://github.com/w3c/openscreenprotocol/issues/">GitHub</a>
      <dd><a href="#issues-index">Inline In Spec</a>
      <dt class="editor">Editor:
      <dd class="editor p-author h-card vcard" data-editor-id="68454"><a class="p-name fn u-url url" href="https://github.com/markafoltz">Mark Foltz</a> (<span class="p-org org">Google</span>)
     </dl>
    </div>
   </details>
   <div data-fill-with="warning"></div>
   <p class="copyright" data-fill-with="copyright"><a href="https://www.w3.org/policies/#copyright">Copyright</a> © 2025 <a href="https://www.w3.org/">World Wide Web Consortium</a>. <abbr title="World Wide Web Consortium">W3C</abbr><sup>®</sup> <a href="https://www.w3.org/policies/#Legal_Disclaimer">liability</a>, <a href="https://www.w3.org/policies/#W3C_Trademarks">trademark</a> and <a href="https://www.w3.org/copyright/software-license/" rel="license" title="W3C Software and Document License">permissive document license</a> rules apply. </p>
   <hr title="Separator for header">
  </div>
  <div class="p-summary" data-fill-with="abstract">
   <h2 class="no-num no-toc no-ref heading settled" id="abstract"><span class="content">Abstract</span></h2>
   <p>The Open Screen Network Protocol is a network protocol that allows
two Open Screen agents to establish a secure network transport in an
interoperable fashion.</p>
  </div>
  <h2 class="no-num no-toc no-ref heading settled" id="sotd"><span class="content">Status of this document</span></h2>
  <div data-fill-with="status">
   <p> <em>This section describes the status of this document at the time of its publication. A list of current <abbr title="World Wide Web Consortium">W3C</abbr> publications and the latest revision of this technical report can be found in the <a href="https://www.w3.org/TR/"><abbr title="World Wide Web Consortium">W3C</abbr> standards and drafts index</a> at https://www.w3.org/TR/.</em> </p>
   <p> This document was published by the <a href="https://www.w3.org/groups/wg/secondscreen">Second Screen Working Group</a> as an Editor’s Draft. This document is intended to become a W3C Recommendation. </p>
   <p> Feedback and comments on this specification are welcome. Please use <a href="https://github.com/w3c/openscreenprotocol/issues">Github issues</a>. </p>
   <p> Publication as an Editor’s Draft does not imply endorsement by <abbr title="World Wide Web Consortium">W3C</abbr> and its Members. This is a draft document and may be updated, replaced or obsoleted by other documents at any time. It is inappropriate to cite this document as other than work in progress. </p>
   <p> This document was produced by a group operating under the <a class="css" data-link-type="property" href="https://www.w3.org/policies/patent-policy/20200915/" id="sotd_patent">W3C Patent Policy</a>. <abbr title="World Wide Web Consortium">W3C</abbr> maintains a <a href="https://www.w3.org/2004/01/pp-impl/74168/status" rel="disclosure">public list of any patent disclosures</a> made in connection with the deliverables of the group; that page also includes instructions for disclosing a patent. An individual who has actual knowledge of a patent which the individual believes contains <a href="https://www.w3.org/policies/patent-policy/20200915/#def-essential">Essential
    Claim(s)</a> must disclose the information in accordance with <a href="https://www.w3.org/policies/patent-policy/20200915/#sec-Disclosure">section 6 of the <abbr title="World Wide Web Consortium">W3C</abbr> Patent Policy</a>. </p>
   <p> This document is governed by the <a href="https://www.w3.org/policies/process/20231103/" id="w3c_process_revision">03 November 2023 W3C Process Document</a>. </p>
  </div>
  <div data-fill-with="at-risk"></div>
  <nav data-fill-with="table-of-contents" id="toc">
   <h2 class="no-num no-toc no-ref" id="contents">Table of Contents</h2>
   <ol class="toc" role="directory">
    <li>
     <a href="#introduction"><span class="secno">1</span> <span class="content">Introduction</span></a>
     <ol class="toc">
      <li><a href="#terminology"><span class="secno">1.1</span> <span class="content">Terminology</span></a>
     </ol>
    <li>
     <a href="#requirements"><span class="secno">2</span> <span class="content">Requirements</span></a>
     <ol class="toc">
      <li><a href="#requirements-general"><span class="secno">2.1</span> <span class="content">General Requirements</span></a>
      <li><a href="#requirements-non-functional"><span class="secno">2.2</span> <span class="content">Non-Functional Requirements</span></a>
     </ol>
    <li>
     <a href="#discovery"><span class="secno">3</span> <span class="content">Discovery with mDNS</span></a>
     <ol class="toc">
      <li><a href="#computing-agent-fingerprint"><span class="secno">3.1</span> <span class="content">Computing the Agent Fingerprint</span></a>
      <li><a href="#computing-certificate-serial-number"><span class="secno">3.2</span> <span class="content">Computing the Certificate Serial Number</span></a>
      <li><a href="#computing-agent-hostname"><span class="secno">3.3</span> <span class="content">Computing the Agent Hostname</span></a>
     </ol>
    <li>
     <a href="#transport"><span class="secno">4</span> <span class="content">Transport and metadata discovery with QUIC</span></a>
     <ol class="toc">
      <li><a href="#tls-13"><span class="secno">4.1</span> <span class="content">TLS 1.3</span></a>
      <li><a href="#certificates"><span class="secno">4.2</span> <span class="content">Agent Certificates</span></a>
     </ol>
    <li><a href="#messages"><span class="secno">5</span> <span class="content">Messages delivery using CBOR and QUIC streams</span></a>
    <li>
     <a href="#authentication"><span class="secno">6</span> <span class="content">Authentication</span></a>
     <ol class="toc">
      <li><a href="#authentication-with-spake2"><span class="secno">6.1</span> <span class="content">Authentication with SPAKE2</span></a>
     </ol>
    <li>
     <a href="#security-privacy"><span class="secno">7</span> <span class="content">Security and Privacy</span></a>
     <ol class="toc">
      <li>
       <a href="#threat-models"><span class="secno">7.1</span> <span class="content">Threat Models</span></a>
       <ol class="toc">
        <li><a href="#passive-network-attackers"><span class="secno">7.1.1</span> <span class="content">Passive Network Attackers</span></a>
        <li><a href="#active-network-attackers"><span class="secno">7.1.2</span> <span class="content">Active Network Attackers</span></a>
        <li><a href="#denial-of-service"><span class="secno">7.1.3</span> <span class="content">Denial of Service</span></a>
       </ol>
      <li>
       <a href="#security-privacy-questions"><span class="secno">7.2</span> <span class="content">Open Screen Network Protocol Security and Privacy Considerations</span></a>
       <ol class="toc">
        <li><a href="#personally-identifiable-information"><span class="secno">7.2.1</span> <span class="content">Personally Identifiable Information &amp; High-Value Data</span></a>
        <li><a href="#cross-origin-state"><span class="secno">7.2.2</span> <span class="content">Cross Origin State Considerations</span></a>
        <li><a href="#origin-access-devices"><span class="secno">7.2.3</span> <span class="content">Origin Access to Other Devices</span></a>
        <li><a href="#private-browsing-mode"><span class="secno">7.2.4</span> <span class="content">Private Browsing Mode</span></a>
        <li><a href="#persistent-state"><span class="secno">7.2.5</span> <span class="content">Persistent State</span></a>
        <li><a href="#other-considerations"><span class="secno">7.2.6</span> <span class="content">Other Considerations</span></a>
       </ol>
      <li>
       <a href="#security-mitigations"><span class="secno">7.3</span> <span class="content">Mitigation Strategies</span></a>
       <ol class="toc">
        <li><a href="#local-passive-mitigations"><span class="secno">7.3.1</span> <span class="content">Local passive network attackers</span></a>
        <li><a href="#local-active-mitigations"><span class="secno">7.3.2</span> <span class="content">Local active network attackers</span></a>
        <li><a href="#remote-active-mitigations"><span class="secno">7.3.3</span> <span class="content">Remote active network attackers</span></a>
        <li><a href="#denial-of-service-mitigations"><span class="secno">7.3.4</span> <span class="content">Denial of service</span></a>
        <li><a href="#malicious-input-mitigations"><span class="secno">7.3.5</span> <span class="content">Malicious input</span></a>
       </ol>
      <li>
       <a href="#security-ui"><span class="secno">7.4</span> <span class="content">User Interface Considerations</span></a>
       <ol class="toc">
        <li><a href="#instance-names"><span class="secno">7.4.1</span> <span class="content">Instance and Display Names</span></a>
       </ol>
     </ol>
    <li><a href="#appendix-a"><span class="secno"></span> <span class="content">Appendix A: Messages</span></a>
    <li>
     <a href="#appendix-b"><span class="secno"></span> <span class="content">Appendix B: PSK Encoding Schemes</span></a>
     <ol class="toc">
      <li><a href="#appendix-c-base-10"><span class="secno"></span> <span class="content">Base-10 Numeric</span></a>
      <li><a href="#appendix-c-qr-code"><span class="secno"></span> <span class="content">QR Code</span></a>
     </ol>
    <li><a href="#appendix-c"><span class="secno"></span> <span class="content">Appendix C: Entire Flow Chart</span></a>
    <li>
     <a href="#w3c-conformance"><span class="secno"></span> <span class="content">Conformance</span></a>
     <ol class="toc">
      <li><a href="#w3c-conventions"><span class="secno"></span> <span class="content">Document conventions</span></a>
      <li><a href="#w3c-conformant-algorithms"><span class="secno"></span> <span class="content">Conformant Algorithms</span></a>
     </ol>
    <li>
     <a href="#index"><span class="secno"></span> <span class="content">Index</span></a>
     <ol class="toc">
      <li><a href="#index-defined-here"><span class="secno"></span> <span class="content">Terms defined by this specification</span></a>
      <li><a href="#index-defined-elsewhere"><span class="secno"></span> <span class="content">Terms defined by reference</span></a>
     </ol>
    <li>
     <a href="#references"><span class="secno"></span> <span class="content">References</span></a>
     <ol class="toc">
      <li><a href="#normative"><span class="secno"></span> <span class="content">Normative References</span></a>
      <li><a href="#informative"><span class="secno"></span> <span class="content">Informative References</span></a>
     </ol>
    <li><a href="#issues-index"><span class="secno"></span> <span class="content">Issues Index</span></a>
   </ol>
  </nav>
  <main>
   <h2 class="heading settled" data-level="1" id="introduction"><span class="secno">1. </span><span class="content">Introduction</span><a class="self-link" href="#introduction"></a></h2>
   <p>The Open Screen Network Protocol provides a baseline set of network protocols
for browsers and devices to discover each other and establish a secure network
connection.  This connection can be used as the transport layer for the <a href="https://w3c.github.io/openscreenprotocol/application.html">Open Screen Application Protocol</a>.</p>
   <p>The Application Protocol and the Network Protocol are independent.  However the
Network Protocol is designed to meet the requirements of the Application
Protocol.  It may or may not be suitable for other application-level protocols
that make use of its transport layer.</p>
   <p>The fundamental flow of the network protocol is:</p>
   <ul>
    <li data-md>
     <p>Use of <a data-link-type="biblio" href="#biblio-rfc6763" title="DNS-Based Service Discovery">DNS-SD</a> for agents to discover each other on the local area
network.</p>
    <li data-md>
     <p>Use of <a data-link-type="biblio" href="#biblio-rfc8446" title="The Transport Layer Security (TLS) Protocol Version 1.3">TLS 1.3</a> with self-signed certificates to establish an
initial, unauthenticated connection.</p>
    <li data-md>
     <p>Use of <a data-link-type="biblio" href="#biblio-rfc9382" title="SPAKE2, a Password-Authenticated Key Exchange">SPAKE2</a> to validate mutual identity and exchange
certificates.</p>
    <li data-md>
     <p>Use of <a data-link-type="biblio" href="#biblio-rfc9000" title="QUIC: A UDP-Based Multiplexed and Secure Transport">QUIC</a> as a transport layer over IP.</p>
   </ul>
   <p>The flow chart in <a href="#appendix-c">Appendix C: Entire Flow Chart</a> illustrates the entire sequence of events.</p>
   <p>The accompanying <a href="https://w3c.github.io/openscreenprotocol/explainer.html">explainer</a> provides
more background on the protocol.</p>
   <h3 class="heading settled" data-level="1.1" id="terminology"><span class="secno">1.1. </span><span class="content">Terminology</span><a class="self-link" href="#terminology"></a></h3>
   <p>An <dfn class="dfn-paneled" data-dfn-type="dfn" data-lt="open screen network protocol agent|osp agent" data-noexport id="open-screen-network-protocol-agent">Open Screen Network
Protocol agent</dfn> (or OSP agent) is any implementation of this protocol
(browser, display, speaker, or other software).</p>
   <h2 class="heading settled" data-level="2" id="requirements"><span class="secno">2. </span><span class="content">Requirements</span><a class="self-link" href="#requirements"></a></h2>
   <h3 class="heading settled" data-level="2.1" id="requirements-general"><span class="secno">2.1. </span><span class="content">General Requirements</span><a class="self-link" href="#requirements-general"></a></h3>
   <ol>
    <li data-md>
     <p>An <a data-link-type="dfn" href="#open-screen-network-protocol-agent" id="ref-for-open-screen-network-protocol-agent">Open Screen Network Protocol agent</a> must be able to discover the presence of
another OSP agent connected to the same IPv4 or IPv6 subnet and reachable by
IP multicast.</p>
    <li data-md>
     <p>An OSP agent must be able to obtain the IPv4 or IPv6 address of
the agent, a display name for the agent, and an IP port number for
establishing a network transport to the agent.</p>
   </ol>
   <h3 class="heading settled" data-level="2.2" id="requirements-non-functional"><span class="secno">2.2. </span><span class="content">Non-Functional Requirements</span><a class="self-link" href="#requirements-non-functional"></a></h3>
   <ol>
    <li data-md>
     <p>It should be possible to implement the Open Screen Network Protocol using modest
hardware requirements, similar to what is found in a low end smartphone,
smart TV or streaming device. See the <a href="https://w3c.github.io/openscreenprotocol/device_specs.html">Device
Specifications</a> document for agent hardware specifications.</p>
    <li data-md>
     <p>The discovery and connection protocols should minimize power consumption,
especially on a <a data-link-type="dfn" href="#listening-agent" id="ref-for-listening-agent">listening agent</a> which is likely to be battery
powered.</p>
    <li data-md>
     <p>The protocol should minimize the amount of information provided to a passive
network observer about the identity of the user or activities on the agent, including
presentations, remote playbacks, or the content of media streams.</p>
    <li data-md>
     <p>The protocol should prevent active network attackers from impersonating a
display and observing or altering data intended for the controller or
receiver.</p>
    <li data-md>
     <p>A listening agent should be able to discover quickly when an <a data-link-type="dfn" href="#advertising-agent" id="ref-for-advertising-agent">advertising agent</a> becomes available or unavailable (i.e., when it connects or
disconnects from the network).</p>
    <li data-md>
     <p>Agents should be able to remember that a user authenticated another agent.
This means it is not required for the user to intervene and re-authenticate
each time an agent wants to connect to an agent that the user has already
authenticated.</p>
    <li data-md>
     <p>Message latency between agents should be minimized to permit interactive
use.  For example, it should be comfortable to type in a form in one agent
and have the text appear in the presentation in real time.  Real-time
latency for gaming or mouse use is ideal, but not a requirement.</p>
   </ol>
   <h2 class="heading settled" data-level="3" id="discovery"><span class="secno">3. </span><span class="content">Discovery with mDNS</span><a class="self-link" href="#discovery"></a></h2>
   <p><a data-link-type="dfn" href="#open-screen-network-protocol-agent" id="ref-for-open-screen-network-protocol-agent①">Open Screen Network Protocol Agents</a> discover one another by advertising and
listening for information identifying themselves along with an IP service
endpoint.  Agent advertisement and discovery through <a data-link-type="biblio" href="#biblio-rfc6763" title="DNS-Based Service Discovery">DNS-SD</a> and <a data-link-type="biblio" href="#biblio-rfc6762" title="Multicast DNS">mDNS</a> is defined by this specification and is mandatory to implement
by all agents. However, agents are free to implement additional discovery
mechanisms, such as querying for the same DNS-SD records via unicast DNS.</p>
   <p>OSP agents must use the DNS-SD <a data-link-type="dfn" href="https://datatracker.ietf.org/doc/html/rfc6763#section-7" id="ref-for-section-7">Service Name</a> <code>_openscreen._udp</code>.</p>
   <p>An <dfn class="dfn-paneled" data-dfn-type="dfn" data-noexport id="advertising-agent">advertising agent</dfn> is one that responds to mDNS queries
for <code>_openscreen._udp.local</code>.  Such an agent should have a <dfn class="dfn-paneled" data-dfn-type="dfn" data-lt="display name" data-noexport id="display-name">display
name</dfn> (a non-empty string) that is a human readable description of the
presentation display, e.g. "Living Room TV."</p>
   <p>A <dfn class="dfn-paneled" data-dfn-type="dfn" data-noexport id="listening-agent">listening agent</dfn> is one that sends mDNS queries for <code>_openscreen._udp.local</code>.  Listening agents may have a display name.</p>
   <p>Advertising agents must use a DNS-SD <a data-link-type="dfn" href="https://datatracker.ietf.org/doc/html/rfc6763#section-4.1.1" id="ref-for-section-4.1.1">Instance Name</a> that is a prefix of the
agent’s display name.  If the Instance Name is not the complete display name, it
must be terminated by a null (<code>\000</code>) character, so that a listening agent knows
it has been truncated.</p>
   <p>Advertising agents must follow the mDNS <a data-link-type="dfn" href="https://datatracker.ietf.org/doc/html/rfc6762#section-9" id="ref-for-section-9">conflict resolution</a> procedure, to
prevent multiple advertising agents from using the same DNS-SD Instance Name.</p>
   <p>Agents should be careful when displaying Instance Names to users; see <a href="#instance-names">§ 7.4.1 Instance and Display Names</a> for guidelines on Instance Name display.</p>
   <p>Advertising agents must include DNS TXT records with the following
keys and values:</p>
   <dl>
    <dt data-md>fp
    <dd data-md>
     <p>The <a data-link-type="dfn" href="#agent-fingerprint" id="ref-for-agent-fingerprint">agent fingerprint</a> of the advertising agent. The steps to compute
the agent fingerprint are defined below.</p>
    <dt data-md>mv
    <dd data-md>
     <p>An unsigned integer value that indicates that metadata has changed.   The
advertising agent must update it to a greater value.  This signals to the
listening agent that it should connect to the advertising agent to discover
updated metadata.  The value should be encoded as a <a data-link-type="dfn" href="https://datatracker.ietf.org/doc/html/rfc9000#name-variable-length-integer-enc" id="ref-for-name-variable-length-integer-enc">variable-length integer</a>.</p>
    <dt data-md>at
    <dd data-md>
     <p>An alphanumeric, unguessable token consisting of characters from the set <code>[A-Za-z0-9+/]</code>.</p>
   </dl>
   <p class="note" role="note"><span class="marker">Note:</span> <code>at</code> prevents off-LAN parties from attempting authentication; see <a href="#remote-active-mitigations">§ 7.3.3 Remote active network attackers</a>. <code>at</code> should have at least 32 bits of true
entropy to make brute force attacks impractical.</p>
   <p class="note" role="note"><span class="marker">NOTE:</span> If an OSP agent suspends its network connectivity (e.g. for power saving
reasons) it should attempt to retain cached and valid mDNS records so that
discovery state is preserved when the network connection is resumed.</p>
   <p>Future extensions to this QUIC-based protocol can use the same metadata
discovery process to indicate support for those extensions, through a
capabilities mechanism to be determined. If a future version of the Open Screen
Network Protocol uses mDNS but breaks compatibility with the metadata discovery process,
it should change the DNS-SD service name to a new value, indicating a new
mechanism for metadata discovery.</p>
   <h3 class="heading settled" data-level="3.1" id="computing-agent-fingerprint"><span class="secno">3.1. </span><span class="content">Computing the Agent Fingerprint</span><a class="self-link" href="#computing-agent-fingerprint"></a></h3>
   <p>The <dfn class="dfn-paneled" data-dfn-type="dfn" data-noexport id="agent-fingerprint">agent fingerprint</dfn> of an agent is computed by following these
steps:</p>
   <ol>
    <li data-md>
     <p>Compute the <a href="https://www.rfc-editor.org/rfc/rfc7469#section-2.4">SKPI Fingerprint</a> of the <a data-link-type="dfn" href="#agent-certificate" id="ref-for-agent-certificate">agent certificate</a> according to <a data-link-type="biblio" href="#biblio-rfc7469" title="Public Key Pinning Extension for HTTP">[RFC7469]</a> using <a data-link-type="biblio" href="#biblio-rfc6234" title="US Secure Hash Algorithms (SHA and SHA-based HMAC and HKDF)">SHA-256</a> as the hash algorithm.</p>
    <li data-md>
     <p>base64 encode the result of Step 1 according to <a data-link-type="biblio" href="#biblio-rfc4648" title="The Base16, Base32, and Base64 Data Encodings">[RFC4648]</a>.</p>
   </ol>
   <p class="note" role="note"><span class="marker">Note:</span> The resulting string will be 44 bytes in length.</p>
   <h3 class="heading settled" data-level="3.2" id="computing-certificate-serial-number"><span class="secno">3.2. </span><span class="content">Computing the Certificate Serial Number</span><a class="self-link" href="#computing-certificate-serial-number"></a></h3>
   <p>Let the <dfn class="dfn-paneled" data-dfn-type="dfn" data-noexport id="certificate-serial-number">certificate serial number</dfn> be the result of the following
steps:</p>
   <ol>
    <li>
     If the agent has never generated an agent certificate: 
     <ol>
      <li>Let the <dfn class="dfn-paneled" data-dfn-type="dfn" data-noexport id="certificate-serial-number-base">certificate serial number base</dfn> be a 128-bit <a data-link-type="dfn" href="https://datatracker.ietf.org/doc/html/rfc4122#section-4.4" id="ref-for-section-4.4">UUID</a>.
      <li>Let the <dfn class="dfn-paneled" data-dfn-type="dfn" data-noexport id="certificate-serial-number-counter">certificate serial number counter</dfn> be a 32-bit
        unsigned integer, initially set to 0.
     </ol>
    <li>
     Generate a 160-bit value as follows: 
     <ol>
      <li>Increment the <a data-link-type="dfn" href="#certificate-serial-number-counter" id="ref-for-certificate-serial-number-counter">certificate serial number counter</a> by one.
      <li>Assign the upper 128 bits to the <a data-link-type="dfn" href="#certificate-serial-number-base" id="ref-for-certificate-serial-number-base">certificate serial number base</a>.
      <li>Assign the lower 32 bits to the <a data-link-type="dfn" href="#certificate-serial-number-counter" id="ref-for-certificate-serial-number-counter①">certificate serial number counter</a>.
     </ol>
   </ol>
   <h3 class="heading settled" data-level="3.3" id="computing-agent-hostname"><span class="secno">3.3. </span><span class="content">Computing the Agent Hostname</span><a class="self-link" href="#computing-agent-hostname"></a></h3>
   <p>Each time the agent changes its DNS-SD <a data-link-type="dfn" href="https://datatracker.ietf.org/doc/html/rfc6763#section-4.1" id="ref-for-section-4.1">Service Instance Name</a> or <a data-link-type="dfn" href="#certificate-serial-number" id="ref-for-certificate-serial-number">certificate serial number</a> it must compute an <dfn class="dfn-paneled" data-dfn-type="dfn" data-noexport id="agent-hostname">agent hostname</dfn> as
follows.</p>
   <ol>
    <li data-md>
     <p>Set <var>base64SerialNumber</var> to the <a data-link-type="biblio" href="#biblio-rfc4648" title="The Base16, Base32, and Base64 Data Encodings">base64</a> encoded <a data-link-type="dfn" href="#certificate-serial-number" id="ref-for-certificate-serial-number①">certificate serial number</a>.</p>
    <li data-md>
     <p>Set <var>encodedInstanceName</var> to the result of the following:</p>
     <ol>
      <li data-md>
       <p>Replace any character in the DNS-SD Instance Name other
than <code>[A-Za-z0-9-]</code> with a hyphen <code>-</code>.</p>
     </ol>
    <li data-md>
     <p>Set <var>encodedDomain</var> to the result of the following:</p>
     <ol>
      <li data-md>
       <p>Replace any character in the DNS-SD Domain Name other
than <code>[A-Za-z0-9-]</code> with a hyphen <code>-</code>.</p>
     </ol>
    <li data-md>
     <p>Set the <a data-link-type="dfn" href="#agent-hostname" id="ref-for-agent-hostname">agent hostname</a> to the string <var>base64SerialNumber</var> + <code>.</code> + <var>encodedInstanceName</var> + <code>.</code> + <var>encodedDomain</var></p>
   </ol>
   <p>TODO: Add an appendix with examples of metadata, DNS-SD records and certificate
fields for an advertising agent.</p>
   <h2 class="heading settled" data-level="4" id="transport"><span class="secno">4. </span><span class="content">Transport and metadata discovery with QUIC</span><a class="self-link" href="#transport"></a></h2>
   <p>If a <a data-link-type="dfn" href="#listening-agent" id="ref-for-listening-agent①">listening agent</a> wants to connect to or learn further metadata about an <a data-link-type="dfn" href="#advertising-agent" id="ref-for-advertising-agent①">advertising agent</a>, it initiates a <a data-link-type="biblio" href="#biblio-rfc9000" title="QUIC: A UDP-Based Multiplexed and Secure Transport">QUIC</a> connection to the IP and port
from its SRV record.  Prior to authentication, a message may be exchanged (such
as further metadata), but such info should be treated as unverified (such as
indicating to a user that a display name of an unauthenticated agent is
unverified).</p>
   <p>The connection IDs used both by agents should be zero length.  If zero length
connection IDs are chosen, agents are restricted from changing IP or port
without establishing a new QUIC connection.  In such cases, agents must
establish a new QUIC connection in order to change IP or port.</p>
   <h3 class="heading settled" data-level="4.1" id="tls-13"><span class="secno">4.1. </span><span class="content">TLS 1.3</span><a class="self-link" href="#tls-13"></a></h3>
   <p>When an <a data-link-type="dfn" href="#open-screen-network-protocol-agent" id="ref-for-open-screen-network-protocol-agent②">OSP Agent</a> makes a QUIC connection to another agent, it must use <a data-link-type="biblio" href="#biblio-rfc8446" title="The Transport Layer Security (TLS) Protocol Version 1.3">TLS 1.3</a> to secure the connection.  TLS 1.3 should be used with the
following application-specific parameters to indicate that the connection will
be used to communicate with a specific OSP Agent using OSP.  An OSP Agent may
refuse incoming connections that lack these parameters.</p>
   <ul>
    <li data-md>
     <p>The <a data-link-type="biblio" href="#biblio-rfc7301" title="Transport Layer Security (TLS) Application-Layer Protocol Negotiation Extension">ALPN</a> used must be "osp".</p>
    <li data-md>
     <p>The <a data-link-type="biblio" href="#biblio-rfc6066" title="Transport Layer Security (TLS) Extensions: Extension Definitions">server_name extension</a> must be set to the <a data-link-type="dfn" href="#agent-hostname" id="ref-for-agent-hostname①">agent hostname</a>.</p>
    <li data-md>
     <p>The <a data-link-type="dfn" href="#agent-fingerprint" id="ref-for-agent-fingerprint①">agent fingerprint</a> calculated for the received <a data-link-type="dfn" href="#agent-certificate" id="ref-for-agent-certificate①">agent certificate</a> must match the <code>fp</code> mDNS TXT record as advertised
by the advertising agent.</p>
   </ul>
   <p>An OSP Agent must not send TLS early data.</p>
   <p class="issue" id="issue-808efb48"><a class="self-link" href="#issue-808efb48"></a> Register ALPN with IANA. <a href="https://github.com/w3c/openscreenprotocol/issues/228">[Issue #228]</a></p>
   <h3 class="heading settled" data-level="4.2" id="certificates"><span class="secno">4.2. </span><span class="content">Agent Certificates</span><a class="self-link" href="#certificates"></a></h3>
   <p>Each OSP Agent must generate an <a data-link-type="biblio" href="#biblio-rfc5280" title="Internet X.509 Public Key Infrastructure Certificate and Certificate Revocation List (CRL) Profile">X.509 v3</a> <dfn class="dfn-paneled" data-dfn-type="dfn" data-lt="agent certificate" data-noexport id="agent-certificate">agent
certificate</dfn> containing a public key to be used with the TLS 1.3
certificate exchange.  Both <a data-link-type="dfn" href="#advertising-agent" id="ref-for-advertising-agent②">advertising agents</a> and <a data-link-type="dfn" href="#listening-agent" id="ref-for-listening-agent②">listening agents</a> must
use the <a data-link-type="dfn" href="#agent-certificate" id="ref-for-agent-certificate②">agent certificate</a> in TLS 1.3 <code>Certificate</code> messages when making a
QUIC connection.</p>
   <p>The <a data-link-type="dfn" href="#agent-certificate" id="ref-for-agent-certificate③">agent certificate</a> must have the following characteristics:</p>
   <ul>
    <li data-md>
     <p>256-bit ECDSA public key.</p>
    <li data-md>
     <p>Self-signed.</p>
    <li data-md>
     <p>Support the <code>ecdsa_secp256r1_sha256</code> <a data-link-type="dfn" href="https://datatracker.ietf.org/doc/html/rfc8446#section-4.2.3" id="ref-for-section-4.2.3">signature scheme</a> as defined in TLS 1.3.</p>
     <ul>
      <li data-md>
       <p>The <code>AlgorithmIdentifier</code> values are as defined in <a data-link-type="biblio" href="#biblio-rfc5480" title="Elliptic Curve Cryptography Subject Public Key Information">[RFC5480]</a> (for public
keys) and <a data-link-type="biblio" href="#biblio-rfc5758" title="Internet X.509 Public Key Infrastructure: Additional Algorithms and Identifiers for DSA and ECDSA">[RFC5758]</a> (for signature schemes).</p>
      <li data-md>
       <p><a data-link-type="biblio" href="#biblio-x690" title="Recommendation X.690 — Information Technology — ASN.1 Encoding Rules — Specification of Basic Encoding Rules (BER), Canonical Encoding Rules (CER), and Distinguished Encoding Rules (DER)">[X690]</a> specifies the Distinguished Encoding Rules (DER) representation
used to encode the identifiers.</p>
     </ul>
    <li data-md>
     <p>Valid for signing.</p>
   </ul>
   <p>Each agent certificate has a unique <a data-link-type="dfn" href="#certificate-serial-number" id="ref-for-certificate-serial-number②">certificate serial number</a> computed
using the steps above.  The value <code>&lt;sn></code> below should be substituted with that
serial number.</p>
   <p>The following X.509 v3 fields are to be set as follows:</p>
   <div class="assertion">
    <table>
     <thead>
      <tr>
       <th>Field
       <th>Value
     <tbody>
      <tr>
       <td>Version Number
       <td>3
      <tr>
       <td>Serial Number
       <td><code>&lt;sn></code> (as a big-endian integer)
      <tr>
       <td>Public Key <code>AlgorithmIdentifier</code>
       <td>
        <ul>
         <li>ECC OID: <code>1.2.840.10045.2.1</code>
         <li>ECDSA 256 OID: <code>1.2.840.10045.3.1.7</code>
         <li>DER representation: <code>301306072a8648ce3d020106082a8648ce3d030107</code>
        </ul>
      <tr>
       <td>Signature <code>AlgorithmIdentifier</code>
       <td>
        <ul>
         <li>OID: <code>1.2.840.10045.4.3.2</code>
         <li>DER representation: <code>300a06082a8648ce3d040302</code>
        </ul>
      <tr>
       <td>Issuer Name
       <td>CN = The <code>model-name</code> from the <code>agent-info</code> message, as
            also set in the <code>agent-info</code> message.<br> O = See note.<br> L = See note.<br> ST = See note.<br> C = See note.<br> 
      <tr>
       <td>Subject Name
       <td>CN = <a data-link-type="dfn" href="#agent-hostname" id="ref-for-agent-hostname②">agent hostname</a><br> O = See note.<br> 
      <tr>
       <td>Subject Public Key Algorithm
       <td>Elliptic Curve Public Key
      <tr>
       <td>Certificate Key usage
       <td><a data-link-type="dfn" href="https://datatracker.ietf.org/doc/html/rfc5280#section-4.2.1.3" id="ref-for-section-4.2.1.3">digitalSignature</a>
    </table>
   </div>
   <p>Mandatory fields not mentioned above should be set according to <a data-link-type="biblio" href="#biblio-rfc5280" title="Internet X.509 Public Key Infrastructure Certificate and Certificate Revocation List (CRL) Profile">[RFC5280]</a>.</p>
   <p class="note" role="note"><span class="marker">Note:</span> The OSP agent may use the implementer or device model name as the value
for the <code>O</code> key for user interface and debugging purposes. It may use the agent
implementer’s or device manufacturer’s location as the value for the location
keys (<code>L</code>, <code>ST</code>, and <code>C</code>) for user interface and debugging purposes.</p>
   <p>If an OSP agent sees an <a data-link-type="dfn" href="#agent-certificate" id="ref-for-agent-certificate④">agent certificate</a> it has not yet verified through <a href="#authentication">§ 6 Authentication</a>, it must treat that agent as unverified and initiate
authentication with that agent before allowing additional messages to be
exchanged with that agent.</p>
   <p>If an OSP agent sees a valid <a data-link-type="dfn" href="#agent-certificate" id="ref-for-agent-certificate⑤">agent certificate</a> it has verified through
authentication, it is not required to initiate authentication with that agent
before sending further messages.</p>
   <p>If a listening agent wishes to receive messages from an advertising agent or an
advertising agent wishes to send messages to a listening agent, it may wish to
keep the QUIC connection alive by periodically sending data on the connection.</p>
   <p>If an OSP agent suspends its network connectivity (e.g. for power saving
reasons), it should attempt to resume QUIC connections to the OSP agents to
which it was previously connected once network connectivity is restored.</p>
   <h2 class="heading settled" data-level="5" id="messages"><span class="secno">5. </span><span class="content">Messages delivery using CBOR and QUIC streams</span><a class="self-link" href="#messages"></a></h2>
   <p>Messages are serialized using <a data-link-type="biblio" href="#biblio-rfc8949" title="Concise Binary Object Representation (CBOR)">CBOR</a>.  To send a group of messages in
order, that group of messages must be sent in one QUIC stream.  Independent
groups of messages (with no ordering dependency across groups) should be sent in
different QUIC streams.  In order to put multiple CBOR-serialized messages into
the the same QUIC stream, the following is used.</p>
   <p class="note" role="note"><span class="marker">NOTE:</span> Open Screen Agents should configure QUIC stream limits (<a data-link-type="dfn" href="https://datatracker.ietf.org/doc/html/rfc9000#section-4.6" id="ref-for-section-4.6">MAX_STREAMS</a>)
to not hinder application performance, keeping in mind the number of concurrent
streams that may be necessary for audio, video, or data streaming use cases.</p>
   <p>For each message, the <a data-link-type="dfn" href="#open-screen-network-protocol-agent" id="ref-for-open-screen-network-protocol-agent③">OSP agent</a> must write into a unidirectional QUIC stream
the following:</p>
   <ol>
    <li data-md>
     <p>A type key representing the type of the message, encoded as a <a data-link-type="dfn" href="https://datatracker.ietf.org/doc/html/rfc9000#name-variable-length-integer-enc" id="ref-for-name-variable-length-integer-enc①">variable-length integer</a> (see <a href="#appendix-a">Appendix A: Messages</a> for type keys)</p>
    <li data-md>
     <p>The message encoded as CBOR.</p>
   </ol>
   <p>If an agent receives a message for which it does not recognize a type key, it
must close the QUIC connection with an application error code of 404 and should
include the unknown type key in the reason phrase of the <a data-link-type="dfn" href="https://datatracker.ietf.org/doc/html/rfc9000#name-connection_close-frames" id="ref-for-name-connection_close-frames">CONNECTION_CLOSE frame</a>.</p>
   <p>Variable-length integers are encoded in the <a data-link-type="dfn" data-refhint-key="09174256" href="https://datatracker.ietf.org/doc/html/rfc9000#name-variable-length-integer-enc" id="ref-for-name-variable-length-integer-enc②">Variable-Length Integer Encoding</a> used by <a data-link-type="biblio" href="#biblio-rfc9000" title="QUIC: A UDP-Based Multiplexed and Secure Transport">QUIC</a>.</p>
   <h2 class="heading settled" data-level="6" id="authentication"><span class="secno">6. </span><span class="content">Authentication</span><a class="self-link" href="#authentication"></a></h2>
   <p>Each supported authentication method is implemeted via authentication messages
specific to that method.  The authentication method is explicitly specified by
the message itself.  The authentication status message is common for all authentication
methods.  Any new authentication method added must define new authentication messages.</p>
   <p><a data-link-type="dfn" href="#open-screen-network-protocol-agent" id="ref-for-open-screen-network-protocol-agent④">Open Screen Network Protocol agents</a> must implement <a href="#authentication-with-spake2">§ 6.1 Authentication with SPAKE2</a> with pre-shared keys.</p>
   <p>Prior to authentication, agents exchange <a data-link-type="dfn" href="#auth-capabilities" id="ref-for-auth-capabilities">auth-capabilities</a> messages specifying
pre-shared key (PSK) ease of input for the user and supported PSK input methods.
The agent with the lowest PSK ease of input presents a PSK to the user when the agent
either sends or receives an authentication request.  In case both agents have the same
PSK ease of input value, the server presents the PSK to the user.  The same pre-shared key
is used by both agents.  The agent presenting the PSK to the user is the PSK presenter,
the agent requiring the user to input the PSK is the PSK consumer.</p>
   <p>PSK ease of input is an integer in the range from 0 to 100 inclusive, where 0 means
it is not possible for the user to input PSK on this device and 100 means
that it’s easy for the user to input PSK on the device.  Supported PSK input methods
are numeric and scanning a QR-code.  Devices with non-zero PSK ease of input must
support the numeric PSK input method.</p>
   <p>Any authentication method may require an <a data-link-type="dfn" href="#auth-initiation-token" id="ref-for-auth-initiation-token">auth-initiation-token</a> before
showing a PSK to the user or requesting PSK input from the user.  For an <a data-link-type="dfn" href="#advertising-agent" id="ref-for-advertising-agent③">advertising agent</a>, the <code>at</code> field in its mDNS TXT record must be used as the <code>auth-initation-token</code> in the the first authentication message sent to or from
that agent.  Agents should discard any authentication message whose <code>auth-initation-token</code> is set and does not match the <code>at</code> provided by the
advertising agent.</p>
   <p>In the <code>psk-min-bits-of-entropy</code> field of the <a data-link-type="dfn" href="#auth-capabilities" id="ref-for-auth-capabilities①">auth-capabilities</a> messsage,
agents may specify the minimum bits of entropy it requires for a PSK, in the
range of 20 to 60 bits inclusive, with a default of 20.  The PSK presenter must
generate a PSK that has at least as many bits of entropy as it receives in this
field, and at least as many bits of entropy as it sends in this field.</p>
   <p>If an agent chooses to show a user a PSK in more than one way (such as both a
QR-code and a numeric PSK), they should be for the same PSK.  If they were
different, the PSK presenter would not know which one the user chose to use, and
that may lead to authentication failures.</p>
   <p><a href="#appendix-c">Appendix C: Entire Flow Chart</a> describes two encoding schemes for PSKs that agents may
support to produce either a string or a <a data-link-type="dfn" href="https://www.iso.org/standard/62021.html#" id="ref-for-something">QR code</a> for display to the user.</p>
   <h3 class="heading settled" data-level="6.1" id="authentication-with-spake2"><span class="secno">6.1. </span><span class="content">Authentication with SPAKE2</span><a class="self-link" href="#authentication-with-spake2"></a></h3>
   <p class="issue" id="issue-dc398825"><a class="self-link" href="#issue-dc398825"></a> [Meta] Track CFRG PAKE competition outcome <a href="https://github.com/w3c/openscreenprotocol/issues/242">[Issue #242]</a></p>
   <p>For all messages and objects defined in this section, see <a href="#appendix-a">Appendix A: Messages</a> for
the full CDDL definitions.</p>
   <p>The default authentication method is <a data-link-type="biblio" href="#biblio-rfc9382" title="SPAKE2, a Password-Authenticated Key Exchange">SPAKE2</a> with the following
cipher suite:</p>
   <ol>
    <li data-md>
     <p>Elliptic curve is <a href="https://www.rfc-editor.org/rfc/rfc7748#section-4.1">edwards25519</a>.</p>
    <li data-md>
     <p>Hash function is <a data-link-type="biblio" href="#biblio-rfc6234" title="US Secure Hash Algorithms (SHA and SHA-based HMAC and HKDF)">SHA-256</a>.</p>
    <li data-md>
     <p>Key derivation function is <a data-link-type="biblio" href="#biblio-rfc5869" title="HMAC-based Extract-and-Expand Key Derivation Function (HKDF)">HKDF</a>.</p>
    <li data-md>
     <p>Message authentication code is <a data-link-type="biblio" href="#biblio-rfc2104" title="HMAC: Keyed-Hashing for Message Authentication">HMAC</a>.</p>
    <li data-md>
     <p>Password hash function is <a data-link-type="biblio" href="#biblio-rfc6234" title="US Secure Hash Algorithms (SHA and SHA-based HMAC and HKDF)">SHA-512</a>.</p>
   </ol>
   <p>Open Screen Network Protocol does not use a memory-hard hash function to hash PSKs with
SPAKE2 and uses SHA-512 instead, as the PSK is one-time use and is not stored in
any form.</p>
   <p>SPAKE2 provides explicit mutual authentication.</p>
   <p>This authentication method assumes the agents share a low-entropy secret,
such as a number or a short password that could be entered by a user on a
phone, a keyboard or a TV remote control.</p>
   <p>SPAKE2 is not symmetric and has two roles, Alice (A) and Bob (B).</p>
   <p>The messages used in this authentication method are: <a data-link-type="dfn" href="#auth-spake2-handshake" id="ref-for-auth-spake2-handshake">auth-spake2-handshake</a>, <a data-link-type="dfn" href="#auth-spake2-confirmation" id="ref-for-auth-spake2-confirmation">auth-spake2-confirmation</a> and <a data-link-type="dfn" href="#auth-status" id="ref-for-auth-status">auth-status</a>.  [SPAKE2] describes in detail
how <a data-link-type="dfn" href="#auth-spake2-handshake" id="ref-for-auth-spake2-handshake①">auth-spake2-handshake</a> and <a data-link-type="dfn" href="#auth-spake2-confirmation" id="ref-for-auth-spake2-confirmation①">auth-spake2-confirmation</a> are computed.</p>
   <p>The values <code>A</code> and <code>B</code> used in SPAKE2 are the <a data-link-type="dfn" href="#agent-fingerprint" id="ref-for-agent-fingerprint②">agent fingerprints</a> of the
client and server, respectively. <code>pw</code> is the PSK presented to the user.</p>
   <p>The PSK presenter or the PSK consumer may initiate authentication (assuming the
role of Alice in SPAKE2).</p>
   <p>If the PSK presenter wants to initiate authentication, it starts the
authentication process by presenting the PSK to the user and sending a <a data-link-type="dfn" href="#auth-spake2-handshake" id="ref-for-auth-spake2-handshake②">auth-spake2-handshake</a> message.  The <code>public-value</code> field of the <a data-link-type="dfn" href="#auth-spake2-handshake" id="ref-for-auth-spake2-handshake③">auth-spake2-handshake</a> message must be set to the value of <code>pA</code> from SPAKE2
and the <code>psk-status</code> field must be set to <code>psk-shown</code>.</p>
   <p>When the PSK consumer receives the <a data-link-type="dfn" href="#auth-spake2-handshake" id="ref-for-auth-spake2-handshake④">auth-spake2-handshake</a> message, the PSK
consumer prompts the user for the PSK input if it has not done so yet.  Once it
receives the PSK, it sends an <a data-link-type="dfn" href="#auth-spake2-handshake" id="ref-for-auth-spake2-handshake⑤">auth-spake2-handshake</a> message with the <code>public-value</code> field set to the value of <code>pB</code> from SPAKE2 and the <code>psk-status</code> field set to <code>psk-input</code>.</p>
   <p>If the PSK consumer wants to initiate authentication, the PSK consumer sends a <a data-link-type="dfn" href="#auth-spake2-handshake" id="ref-for-auth-spake2-handshake⑥">auth-spake2-handshake</a> message to the PSK presenter with the <code>psk-status</code> field set to <code>psk-needs-presentation</code> and the <code>public-value</code> field set to <code>pA</code>. The PSK presenter, on receiving this message, creates a PSK and presents
it to the the user.  Once that is done, it sends an <a data-link-type="dfn" href="#auth-spake2-handshake" id="ref-for-auth-spake2-handshake⑦">auth-spake2-handshake</a> message to the PSK consumer with <code>psk-status</code> set to <code>psk-input</code> and the <code>public-value</code> field set to <code>pB</code>.</p>
   <p>Once an agent knows both <code>pA</code> and <code>pB</code> from <a data-link-type="dfn" href="#auth-spake2-handshake" id="ref-for-auth-spake2-handshake⑧">auth-spake2-handshake</a> messages,
it computes and sends a <a data-link-type="dfn" href="#auth-spake2-confirmation" id="ref-for-auth-spake2-confirmation②">auth-spake2-confirmation</a> with the <code>confirmation-value</code> field set to <code>cA</code> (for Alice) or <code>cB</code> (for Bob) to the
other agent.</p>
   <p>Once an agent receives an <a data-link-type="dfn" href="#auth-spake2-confirmation" id="ref-for-auth-spake2-confirmation③">auth-spake2-confirmation</a> message, it validates
that message using the procedure in [SPAKE2] and then replies with an <a data-link-type="dfn" href="#auth-status" id="ref-for-auth-status①">auth-status</a> authenticated message to the other agent.  Any value of <code>result</code> other than <code>authenticated</code> means that authentication failed, and the agent must
immediately disconnect.</p>
   <p class="note" role="note"><span class="marker">NOTE:</span> The <a data-link-type="dfn" href="#auth-status" id="ref-for-auth-status②">auth-status</a> message is merely informative as each agent
independently computes the outcome of SPAKE2 through key confirmation
verification.</p>
   <p><a href="#appendix-c">Appendix C: Entire Flow Chart</a> shows the entire process when agents have not
authenticated each other, including discovery, QUIC connection establishment,
metadata exchange and authentication. When agents have completed authentication,
the authentication phase can be omitted.</p>
   <h2 class="heading settled" data-level="7" id="security-privacy"><span class="secno">7. </span><span class="content">Security and Privacy</span><a class="self-link" href="#security-privacy"></a></h2>
   <p>The Open Screen Network Protocol allows two <a data-link-type="dfn" href="#open-screen-network-protocol-agent" id="ref-for-open-screen-network-protocol-agent⑤">OSP agents</a> to discover each other and
exchange user and application data.  As such, its security and privacy
considerations should be closely examined.  We evaluate the protocol itself
using the W3C <a data-link-type="biblio" href="#biblio-security-privacy-questionnaire" title="Self-Review Questionnaire: Security and Privacy">Security and Privacy Questionnaire</a> and also discuss recommended mitigations that agents can use to meet these
security and privacy requirements.</p>
   <h3 class="heading settled" data-level="7.1" id="threat-models"><span class="secno">7.1. </span><span class="content">Threat Models</span><a class="self-link" href="#threat-models"></a></h3>
   <h4 class="heading settled" data-level="7.1.1" id="passive-network-attackers"><span class="secno">7.1.1. </span><span class="content">Passive Network Attackers</span><a class="self-link" href="#passive-network-attackers"></a></h4>
   <p>The Open Screen Network Protocol should assume that all parties that are connected to
the same LAN are able to observe all data flowing between OSP agents.</p>
   <p>These parties will be able collect any data exposed through unencrypted
messages, such as mDNS records and the QUIC handshakes.</p>
   <p>These parties may attempt to learn cryptographic parameters by observing data
flows on the QUIC connection, or by observing cryptographic timing.</p>
   <h4 class="heading settled" data-level="7.1.2" id="active-network-attackers"><span class="secno">7.1.2. </span><span class="content">Active Network Attackers</span><a class="self-link" href="#active-network-attackers"></a></h4>
   <p>Active attackers, such as compromised routers, will be able to manipulate data
exchanged between agents.  They can inject traffic into existing QUIC
connections and attempt to initiate new QUIC connections.  These abilities can
be used to attempt the following:</p>
   <ul>
    <li data-md>
     <p>Impersonate an agent or one already authenticated by the user, in an attempt
to convince the user to authenticate to it.</p>
    <li data-md>
     <p>Connect to an agent and query its capabilities.</p>
   </ul>
   <p>One particular attack of concern is misconfigured or compromised routers that
expose local network devices (such as OSP agents) to the Internet.  This vector
of attack has been used by malicious parties to take control of printers and
smart TVs by connecting to local network services that would normally be
inaccessible from the Internet.</p>
   <h4 class="heading settled" data-level="7.1.3" id="denial-of-service"><span class="secno">7.1.3. </span><span class="content">Denial of Service</span><a class="self-link" href="#denial-of-service"></a></h4>
   <p>Parties with connected to the LAN may attempt to deny access to OSP agents.  For
example, an attacker my attempt to open a large number of QUIC connections to an
agent in an attempt to block legitimate connections or exhaust the agent’s
system resources.  They may also multicast spurious DNS-SD records in an attempt
to exhaust the cache capacity for mDNS listeners, or to get listeners to open a
large number of bogus QUIC connections.</p>
   <h3 class="heading settled" data-level="7.2" id="security-privacy-questions"><span class="secno">7.2. </span><span class="content">Open Screen Network Protocol Security and Privacy Considerations</span><a class="self-link" href="#security-privacy-questions"></a></h3>
   <h4 class="heading settled" data-level="7.2.1" id="personally-identifiable-information"><span class="secno">7.2.1. </span><span class="content">Personally Identifiable Information &amp; High-Value Data</span><a class="self-link" href="#personally-identifiable-information"></a></h4>
   <p>The following data cannot be reasonably made confidential and should be
considered public:</p>
   <ol>
    <li data-md>
     <p>IP addresses and ports used by the Open Screen Network Protocol.</p>
    <li data-md>
     <p>Data advertised through mDNS, including the display name prefix, the
certificate fingerprint and serial number, and the metadata version.</p>
   </ol>
   <h4 class="heading settled" data-level="7.2.2" id="cross-origin-state"><span class="secno">7.2.2. </span><span class="content">Cross Origin State Considerations</span><a class="self-link" href="#cross-origin-state"></a></h4>
   <p>The network protocol does not directly handle origin state.</p>
   <h4 class="heading settled" data-level="7.2.3" id="origin-access-devices"><span class="secno">7.2.3. </span><span class="content">Origin Access to Other Devices</span><a class="self-link" href="#origin-access-devices"></a></h4>
   <p>By design, the Open Screen Network Network Protocol allows access to devices from the
Web, through application protocols that use it.  By implementing the protocol,
these devices are knowingly making themselves available to the Web and should be
designed accordingly.</p>
   <p>Below, we discuss mitigation steps to prevent malicious use of these devices.</p>
   <h4 class="heading settled" data-level="7.2.4" id="private-browsing-mode"><span class="secno">7.2.4. </span><span class="content">Private Browsing Mode</span><a class="self-link" href="#private-browsing-mode"></a></h4>
   <p>It’s recommended that user agents use separate authentication contexts (see <a href="#authentication">§ 6 Authentication</a>) and QUIC connections (see <a href="#transport">§ 4 Transport and metadata discovery with QUIC</a>) for normal and
private browsing from the same user agent instance. This makes it more difficult
for other devices to match activities occurring in normal and private browsing
by the same user.</p>
   <h4 class="heading settled" data-level="7.2.5" id="persistent-state"><span class="secno">7.2.5. </span><span class="content">Persistent State</span><a class="self-link" href="#persistent-state"></a></h4>
   <p>An agent is likely to persist the identity of agents that have successfully
completed <a href="#authentication">§ 6 Authentication</a>.  This may include the public key fingerprints,
metadata versions, and metadata for those parties.</p>
   <p>However, this data is not normally exposed to the Web, only through the native
UI of the user agent during the display selection or display authentication
process.  It can be an implementation choice whether the user agent clears or
retains this data when the user clears browsing data.</p>
   <h4 class="heading settled" data-level="7.2.6" id="other-considerations"><span class="secno">7.2.6. </span><span class="content">Other Considerations</span><a class="self-link" href="#other-considerations"></a></h4>
   <p>The Open Screen Network Network Protocol does not grant to the Web additional access to
the following:</p>
   <ul>
    <li data-md>
     <p>New script loading mechanisms</p>
    <li data-md>
     <p>Access to the user’s location</p>
    <li data-md>
     <p>Access to device sensors</p>
    <li data-md>
     <p>Access to the user’s local computing environment</p>
    <li data-md>
     <p>Control over the user agent’s native UI</p>
    <li data-md>
     <p>Security characteristics of the user agent</p>
   </ul>
   <h3 class="heading settled" data-level="7.3" id="security-mitigations"><span class="secno">7.3. </span><span class="content">Mitigation Strategies</span><a class="self-link" href="#security-mitigations"></a></h3>
   <h4 class="heading settled" data-level="7.3.1" id="local-passive-mitigations"><span class="secno">7.3.1. </span><span class="content">Local passive network attackers</span><a class="self-link" href="#local-passive-mitigations"></a></h4>
   <p>Local passive attackers may attempt to harvest data about user activities and
device capabilities using the Open Screen Network Protocol.  The main strategy to address
this is data minimization, by only exposing opaque public key fingerprints
before user-mediated authentication takes place.</p>
   <p>Passive attackers may also attempt timing attacks to learn the cryptographic
parameters of the TLS 1.3 QUIC connection.  The application profile for TLS 1.3
mandates constant-time ciphers and TLS 1.3 implementations should use elliptic
curve signing operations that are resistant to side channel attacks.</p>
   <h4 class="heading settled" data-level="7.3.2" id="local-active-mitigations"><span class="secno">7.3.2. </span><span class="content">Local active network attackers</span><a class="self-link" href="#local-active-mitigations"></a></h4>
   <p>Local active attackers may attempt to impersonate a presentation display the
user would normally trust.  The <a href="#authentication">§ 6 Authentication</a> step of the Open Screen
Network Protocol prevents a man-in-the-middle from impersonating an agent, without
knowledge of a shared secret.  However, it is possible for an attacker to
impersonate an existing, trusted agent or a newly discovered agent that is not
yet authenticated and try to convince the user to authenticate to it.  (Trust in
this context means that a user has completed <a href="#authentication">§ 6 Authentication</a> from their
agent to another agent.)</p>
   <p>This can be addressed through a combination of techniques.  The first is
detecting attempts at impersonation.  Agents should detect the following
situations and flag an agent that meets any of the criteria as a <dfn class="dfn-paneled" data-dfn-type="dfn" data-lt="suspicious agent" data-noexport id="suspicious-agent">suspicious
agent</dfn>:</p>
   <ul>
    <li data-md>
     <p>Agents with distinct IP endpoints whose public key fingerprints collide during
concurrent advertisement.</p>
    <li data-md>
     <p>Untrusted agents whose display name differs from the one previously
advertised under a given public key fingerprint.</p>
    <li data-md>
     <p>Untrusted agents that fail the authentication challenge a certain number of times.</p>
    <li data-md>
     <p>Untrusted agents that advertise a display name that is similar to that from an
already-trusted agent.</p>
   </ul>
   <p>The second is through management of the low-entropy secret during mutual
authentication:</p>
   <ul>
    <li data-md>
     <p>Rotate the low-entropy secret to prevent brute force attacks.</p>
    <li data-md>
     <p>Use an increasing backoff to respond to authentication challenges, also to
prevent brute force attacks.</p>
    <li data-md>
     <p>Use a cryptographically sound source of entropy to generate the shared secret.</p>
   </ul>
   <p>The active attacker may also attempt to disrupt data exchanged over the QUIC
connection by injecting or modifying traffic.  These attacks should be mitigated
by a correct implementation of TLS 1.3.  See Appendix E of <a data-link-type="biblio" href="#biblio-rfc8446" title="The Transport Layer Security (TLS) Protocol Version 1.3">[RFC8446]</a> for a
detailed security analysis of the TLS 1.3 protocol.</p>
   <h4 class="heading settled" data-level="7.3.3" id="remote-active-mitigations"><span class="secno">7.3.3. </span><span class="content">Remote active network attackers</span><a class="self-link" href="#remote-active-mitigations"></a></h4>
   <p>Unfortunately, we cannot rely on network devices to fully protect OSP agents,
because a misconfigured firewall or NAT could expose a LAN-connected agent to
the broader Internet.  OSP agents should be secure against attack from any
Internet host.</p>
   <p>Advertising agents must set the <code>at</code> field in their mDNS TXT record to protect
themselves from off-LAN attempts to initiate <a href="#authentication">§ 6 Authentication</a>, which result
in user annoyance (display or input of PSK) and potential brute force attacks
against the PSK.</p>
   <h4 class="heading settled" data-level="7.3.4" id="denial-of-service-mitigations"><span class="secno">7.3.4. </span><span class="content">Denial of service</span><a class="self-link" href="#denial-of-service-mitigations"></a></h4>
   <p>It will be difficult to completely prevent denial service of attacks that
originate on the user’s local area network.  OSP agents can refuse new
connections, close connections that receive too many messages, or limit the
number of mDNS records cached from a specific responder in an attempt to allow
existing activities to continue in spite of such an attack.</p>
   <h4 class="heading settled" data-level="7.3.5" id="malicious-input-mitigations"><span class="secno">7.3.5. </span><span class="content">Malicious input</span><a class="self-link" href="#malicious-input-mitigations"></a></h4>
   <p>OSP agents should be robust against malicious input that attempts to compromise
the target device by exploiting parsing vulnerabilities.</p>
   <p>Where possible, OSP agents (including application level components like content
and media rendering) should use defense-in-depth techniques like <a href="https://en.wikipedia.org/wiki/Sandbox_(computer_security)">sandboxing</a> to prevent vulnerabilities from gaining access to user data or leading to
persistent exploits.</p>
   <h3 class="heading settled" data-level="7.4" id="security-ui"><span class="secno">7.4. </span><span class="content">User Interface Considerations</span><a class="self-link" href="#security-ui"></a></h3>
   <p>This specification does not make any specific requirements of the security
relevant user interfaces of OSP agents.  However there are important
considerations when designing these user interfaces, as PSK-based authentication
requires users to make informed decisions about which agents to trust.</p>
   <ol>
    <li data-md>
     <p>Before an agent has authenticated another device, the agent should make it
clear that any data from that device has not been verified by
authentication.  (See below for how this applies to DNS-SD Instance Names.)</p>
    <li data-md>
     <p>A <a data-link-type="dfn" href="#suspicious-agent" id="ref-for-suspicious-agent">suspicious agent</a> should be displayed differently from trusted
agents that are not suspicious, or not displayed at all.</p>
    <li data-md>
     <p>The user interface to present a PSK during authentication should be done in
trusted UI and be difficult to spoof.  It should be clear to the user which
physical device is presenting the PSK.</p>
    <li data-md>
     <p>The user interface to input a PSK during authentication should be done in
trusted UI and be difficult to spoof.</p>
    <li data-md>
     <p>The user should be required to take action to input the PSK, to prevent the
user from blindly clicking through this step.</p>
    <li data-md>
     <p>The user interfaces to render and input a PSK should meet accessibility
guidelines.</p>
   </ol>
   <h4 class="heading settled" data-level="7.4.1" id="instance-names"><span class="secno">7.4.1. </span><span class="content">Instance and Display Names</span><a class="self-link" href="#instance-names"></a></h4>
   <p>Because DNS-SD <a data-link-type="dfn" href="https://datatracker.ietf.org/doc/html/rfc6763#section-4.1.1" id="ref-for-section-4.1.1①">Instance Names</a> are the primary information that the user
sees prior to authentication, careful presentation of these names is necessary.</p>
   <p class="issue" id="issue-40e518b1"><a class="self-link" href="#issue-40e518b1"></a> Rephrase to not link DNS-SD with an agent-info, an application
message. <a href="https://github.com/w3c/openscreenprotocol/issues/346">[Issue #346]</a></p>
   <p>Agents must treat Instance Names as unverified information, and should check
that the Instance Name is a prefix of the display name received through the <code>agent-info</code> message after a successful QUIC connection.  Once an
agent has done this check, it can show the name as a <dfn class="dfn-paneled" data-dfn-type="dfn" data-lt="verified display name" data-noexport id="verified-display-name">verified
display name</dfn>.</p>
   <p>Agents should show only complete display names to the user, instead of truncated
display names from DNS-SD.  A truncated display name should be verified as above
before being shown in full as a <a data-link-type="dfn" href="#verified-display-name" id="ref-for-verified-display-name">verified display name</a>.</p>
   <div class="note" role="note">
     This means there are three categories of display names that agents should be
capable of handling: 
    <ol>
     <li> Truncated and unverified DNS-SD Instance Names, which should not be shown
       to the user.
     <li> Complete but unverified DNS-SD Instance Names, which can be shown as
       unverified prior to <a href="#authentication">§ 6 Authentication</a>.
     <li>Verified display names.
    </ol>
   </div>
   <h2 class="heading settled" id="appendix-a"><span class="content">Appendix A: Messages</span><a class="self-link" href="#appendix-a"></a></h2>
   <p>The following messages are defined using the <a data-link-type="dfn" href="https://datatracker.ietf.org/doc/html/rfc8610#section-3" id="ref-for-section-3">Concise Data Definition Language</a> syntax. When integer keys are used, a comment is appended to the line
to indicate the name of the field. Object definitions in this specification have
this unusual syntax to reduce the number of bytes-on-the-wire, while maintaining
a human-readable name for each key. Integer keys are used instead of object
arrays to allow for easy indexing of optional fields.</p>
   <p>Each root message (one that can be put into a QUIC stream without being enclosed
by another message) has a comment indicating the message type key.</p>
   <p>Smaller numbers should be reserved for message that will be sent more frequently
or are very small or both and larger numbers should be reserved for messages
that are infrequently sent or large or both because smaller type keys encode on
the wire smaller.</p>
   <div class="highlight">
    <div>
<pre><span class="c1">; type key 1001</span>
<span class="nc"><dfn class="dfn-paneled" data-dfn-type="dfn" data-noexport id="auth-capabilities">auth-capabilities</dfn> </span><span class="p">=</span> <span class="p">{</span>
  <span class="mi">0</span><span class="p">:</span> <span class="kt">uint</span> <span class="c1">; psk-ease-of-input</span>
  <span class="mi">1</span><span class="p">:</span> <span class="p">[</span><span class="o">*</span> <span class="nx">psk-input-method</span><span class="p">]</span> <span class="c1">; psk-input-methods</span>
  <span class="mi">2</span><span class="p">:</span> <span class="kt">uint</span> <span class="c1">; psk-min-bits-of-entropy</span>
<span class="p">}</span>

<span class="nc">psk-input-method </span><span class="p">=</span> <span class="o">&amp;</span><span class="p">(</span>
  <span class="nx">numeric</span><span class="p">:</span> <span class="mi">0</span>
  <span class="nx">qr-code</span><span class="p">:</span> <span class="mi">1</span>
<span class="p">)</span>

<span class="nc"><dfn class="dfn-paneled" data-dfn-type="dfn" data-noexport id="auth-initiation-token">auth-initiation-token</dfn> </span><span class="p">=</span> <span class="p">{</span>
  <span class="p">?</span> <span class="mi">0</span><span class="p">:</span> <span class="nx">text </span><span class="c1">; token</span>
<span class="p">}</span>

<span class="nc">auth-spake2-psk-status </span><span class="p">=</span> <span class="o">&amp;</span><span class="p">(</span>
  <span class="nx">psk-needs-presentation</span><span class="p">:</span> <span class="mi">0</span>
  <span class="nx">psk-shown</span><span class="p">:</span> <span class="mi">1</span>
  <span class="nx">psk-input</span><span class="p">:</span> <span class="mi">2</span>
<span class="p">)</span>

<span class="c1">; type key 1003</span>
<span class="nc"><dfn class="dfn-paneled" data-dfn-type="dfn" data-noexport id="auth-spake2-confirmation">auth-spake2-confirmation</dfn> </span><span class="p">=</span> <span class="p">{</span>
  <span class="mi">0</span><span class="p">:</span> <span class="nx">bytes .size 64 </span><span class="c1">; confirmation-value</span>
<span class="p">}</span>

<span class="nc">auth-status-result </span><span class="p">=</span> <span class="o">&amp;</span><span class="p">(</span>
  <span class="nx">authenticated</span><span class="p">:</span> <span class="mi">0</span>
  <span class="nx">unknown-error</span><span class="p">:</span> <span class="mi">1</span>
  <span class="nx">timeout</span><span class="p">:</span> <span class="mi">2</span>
  <span class="nx">secret-unknown</span><span class="p">:</span> <span class="mi">3</span>
  <span class="nx">validation-took-too-long </span><span class="p">:</span> <span class="mi">4</span>
  <span class="nx">proof-invalid</span><span class="p">:</span> <span class="mi">5</span>
<span class="p">)</span>

<span class="c1">; type key 1004</span>
<span class="nc"><dfn class="dfn-paneled" data-dfn-type="dfn" data-noexport id="auth-status">auth-status</dfn> </span><span class="p">=</span> <span class="p">{</span>
  <span class="mi">0</span><span class="p">:</span> <span class="nx">auth-status-result </span><span class="c1">; result</span>
<span class="p">}</span>

<span class="c1">; type key 1005</span>
<span class="nc"><dfn class="dfn-paneled" data-dfn-type="dfn" data-noexport id="auth-spake2-handshake">auth-spake2-handshake</dfn> </span><span class="p">=</span> <span class="p">{</span>
  <span class="mi">0</span><span class="p">:</span> <span class="nx">auth-initiation-token</span><span class="c1">; initiation-token</span>
  <span class="mi">1</span><span class="p">:</span> <span class="nx">auth-spake2-psk-status </span><span class="c1">; psk-status</span>
  <span class="mi">2</span><span class="p">:</span> <span class="nx">bytes </span><span class="c1">; public-value</span>
<span class="p">}</span>
</pre>
    </div>
   </div>
   <h2 class="heading settled" id="appendix-b"><span class="content">Appendix B: PSK Encoding Schemes</span><a class="self-link" href="#appendix-b"></a></h2>
   <p>The following appendix describes two encoding schemes for PSKs that take a value <code>P</code> between 20 bits and 80 bits in length and produce either a string or a <a data-link-type="dfn" href="https://www.iso.org/standard/62021.html#" id="ref-for-something①">QR code</a> for display to the user.</p>
   <p>Agents should use these encoding schemes to maximize the interoperability of the
authentication step, which typically requires displaying the PSK on one
device and the user inputting it on another device.</p>
   <h3 class="heading settled" id="appendix-c-base-10"><span class="content">Base-10 Numeric</span><a class="self-link" href="#appendix-c-base-10"></a></h3>
   <p>To encode <code>P</code> into a numeric string, follow these steps:</p>
   <ol>
    <li data-md>
     <p>Convert <code>P</code> to a base-10 integer <code>N</code>.</p>
    <li data-md>
     <p>If <code>N</code> has fewer than 9 digits:</p>
     <ul>
      <li data-md>
       <p>Zero-pad <code>N</code> on the left with <code>3 - len(N) mod 3</code> digits.</p>
      <li data-md>
       <p>Output <code>N</code> in groups of three digits separated by dashes.</p>
     </ul>
    <li data-md>
     <p>If <code>N</code> has more than 9 digits:</p>
     <ul>
      <li data-md>
       <p>Zero-pad <code>N</code> on the left with <code>4 - len(N) mod 4</code> digits.</p>
      <li data-md>
       <p>Output <code>N</code> in groups of four digits separated by dashes.</p>
     </ul>
   </ol>
   <div class="example" id="example-7640121e"><a class="self-link" href="#example-7640121e"></a> For PSK <code>61488548833</code>, the steps would produce the string <code>0614-8854-8833</code>. </div>
   <p>To decode a string <code>N</code> into a PSK <code>P</code>, follow these steps:</p>
   <ol>
    <li data-md>
     <p>Remove dashes and leading zeros from <code>N</code>.</p>
    <li data-md>
     <p>Parse <code>N</code> as a base-10 decimal number to obtain <code>P</code>.</p>
   </ol>
   <p class="note" role="note"><span class="marker">Note:</span> <code>P</code> values between approximately 2^30 and 2^40 will produce values between
10 and 12 digits in length.  Values over 12 digits are inconvenient to input
and have limited additional security value.</p>
   <p class="note" role="note"><span class="marker">Note:</span> We do not allow the use of hexadecimal encoding here, because it would
be ambiguous with base-10 numeric encodings, and not all devices may support
alphanumeric input.</p>
   <h3 class="heading settled" id="appendix-c-qr-code"><span class="content">QR Code</span><a class="self-link" href="#appendix-c-qr-code"></a></h3>
   <p>To encode a PSK into a QR code, follow these steps:</p>
   <ol>
    <li data-md>
     <p>Set <code>N</code> to the value of <code>P</code> converted to an ASCII-encoded, hexadecimal string.</p>
    <li data-md>
     <p>Construct a text <a data-link-type="dfn" href="https://www.iso.org/standard/62021.html#" id="ref-for-something②">QR code</a> with the value of <code>N</code>.</p>
   </ol>
   <div class="example" id="example-9c4041cf">
    <a class="self-link" href="#example-9c4041cf"></a> For PSK <code>61488548833</code>, the steps would produce the following QR code: 
    <p>
     <svg height="20%" stroke="none" version="1.1" viewBox="0 0 29 29" width="20%" xmlns="http://www.w3.org/2000/svg">
      <rect fill="#FFFFFF" height="100%" width="100%"></rect>
      <path d="M4,4h1v1h-1z M5,4h1v1h-1z M6,4h1v1h-1z M7,4h1v1h-1z M8,4h1v1h-1z M9,4h1v1h-1z M10,4h1v1h-1z M12,4h1v1h-1z M18,4h1v1h-1z M19,4h1v1h-1z M20,4h1v1h-1z M21,4h1v1h-1z M22,4h1v1h-1z M23,4h1v1h-1z M24,4h1v1h-1z M4,5h1v1h-1z M10,5h1v1h-1z M14,5h1v1h-1z M16,5h1v1h-1z M18,5h1v1h-1z M24,5h1v1h-1z M4,6h1v1h-1z M6,6h1v1h-1z M7,6h1v1h-1z M8,6h1v1h-1z M10,6h1v1h-1z M14,6h1v1h-1z M16,6h1v1h-1z M18,6h1v1h-1z M20,6h1v1h-1z M21,6h1v1h-1z M22,6h1v1h-1z M24,6h1v1h-1z M4,7h1v1h-1z M6,7h1v1h-1z M7,7h1v1h-1z M8,7h1v1h-1z M10,7h1v1h-1z M12,7h1v1h-1z M18,7h1v1h-1z M20,7h1v1h-1z M21,7h1v1h-1z M22,7h1v1h-1z M24,7h1v1h-1z M4,8h1v1h-1z M6,8h1v1h-1z M7,8h1v1h-1z M8,8h1v1h-1z M10,8h1v1h-1z M13,8h1v1h-1z M15,8h1v1h-1z M18,8h1v1h-1z M20,8h1v1h-1z M21,8h1v1h-1z M22,8h1v1h-1z M24,8h1v1h-1z M4,9h1v1h-1z M10,9h1v1h-1z M13,9h1v1h-1z M15,9h1v1h-1z M16,9h1v1h-1z M18,9h1v1h-1z M24,9h1v1h-1z M4,10h1v1h-1z M5,10h1v1h-1z M6,10h1v1h-1z M7,10h1v1h-1z M8,10h1v1h-1z M9,10h1v1h-1z M10,10h1v1h-1z M12,10h1v1h-1z M14,10h1v1h-1z M16,10h1v1h-1z M18,10h1v1h-1z M19,10h1v1h-1z M20,10h1v1h-1z M21,10h1v1h-1z M22,10h1v1h-1z M23,10h1v1h-1z M24,10h1v1h-1z M15,11h1v1h-1z M16,11h1v1h-1z M6,12h1v1h-1z M8,12h1v1h-1z M9,12h1v1h-1z M10,12h1v1h-1z M12,12h1v1h-1z M15,12h1v1h-1z M16,12h1v1h-1z M17,12h1v1h-1z M21,12h1v1h-1z M24,12h1v1h-1z M4,13h1v1h-1z M6,13h1v1h-1z M8,13h1v1h-1z M9,13h1v1h-1z M11,13h1v1h-1z M14,13h1v1h-1z M15,13h1v1h-1z M18,13h1v1h-1z M19,13h1v1h-1z M21,13h1v1h-1z M24,13h1v1h-1z M4,14h1v1h-1z M5,14h1v1h-1z M7,14h1v1h-1z M8,14h1v1h-1z M10,14h1v1h-1z M11,14h1v1h-1z M13,14h1v1h-1z M14,14h1v1h-1z M15,14h1v1h-1z M16,14h1v1h-1z M17,14h1v1h-1z M20,14h1v1h-1z M22,14h1v1h-1z M5,15h1v1h-1z M7,15h1v1h-1z M9,15h1v1h-1z M11,15h1v1h-1z M12,15h1v1h-1z M13,15h1v1h-1z M14,15h1v1h-1z M17,15h1v1h-1z M19,15h1v1h-1z M24,15h1v1h-1z M4,16h1v1h-1z M6,16h1v1h-1z M7,16h1v1h-1z M9,16h1v1h-1z M10,16h1v1h-1z M11,16h1v1h-1z M13,16h1v1h-1z M16,16h1v1h-1z M17,16h1v1h-1z M20,16h1v1h-1z M21,16h1v1h-1z M22,16h1v1h-1z M23,16h1v1h-1z M24,16h1v1h-1z M12,17h1v1h-1z M13,17h1v1h-1z M14,17h1v1h-1z M15,17h1v1h-1z M16,17h1v1h-1z M17,17h1v1h-1z M19,17h1v1h-1z M20,17h1v1h-1z M21,17h1v1h-1z M22,17h1v1h-1z M23,17h1v1h-1z M24,17h1v1h-1z M4,18h1v1h-1z M5,18h1v1h-1z M6,18h1v1h-1z M7,18h1v1h-1z M8,18h1v1h-1z M9,18h1v1h-1z M10,18h1v1h-1z M13,18h1v1h-1z M14,18h1v1h-1z M15,18h1v1h-1z M16,18h1v1h-1z M18,18h1v1h-1z M20,18h1v1h-1z M4,19h1v1h-1z M10,19h1v1h-1z M12,19h1v1h-1z M13,19h1v1h-1z M17,19h1v1h-1z M18,19h1v1h-1z M19,19h1v1h-1z M21,19h1v1h-1z M23,19h1v1h-1z M4,20h1v1h-1z M6,20h1v1h-1z M7,20h1v1h-1z M8,20h1v1h-1z M10,20h1v1h-1z M12,20h1v1h-1z M13,20h1v1h-1z M15,20h1v1h-1z M16,20h1v1h-1z M18,20h1v1h-1z M22,20h1v1h-1z M23,20h1v1h-1z M24,20h1v1h-1z M4,21h1v1h-1z M6,21h1v1h-1z M7,21h1v1h-1z M8,21h1v1h-1z M10,21h1v1h-1z M13,21h1v1h-1z M14,21h1v1h-1z M15,21h1v1h-1z M16,21h1v1h-1z M18,21h1v1h-1z M19,21h1v1h-1z M20,21h1v1h-1z M21,21h1v1h-1z M23,21h1v1h-1z M4,22h1v1h-1z M6,22h1v1h-1z M7,22h1v1h-1z M8,22h1v1h-1z M10,22h1v1h-1z M12,22h1v1h-1z M14,22h1v1h-1z M17,22h1v1h-1z M18,22h1v1h-1z M19,22h1v1h-1z M21,22h1v1h-1z M24,22h1v1h-1z M4,23h1v1h-1z M10,23h1v1h-1z M14,23h1v1h-1z M15,23h1v1h-1z M18,23h1v1h-1z M20,23h1v1h-1z M21,23h1v1h-1z M23,23h1v1h-1z M24,23h1v1h-1z M4,24h1v1h-1z M5,24h1v1h-1z M6,24h1v1h-1z M7,24h1v1h-1z M8,24h1v1h-1z M9,24h1v1h-1z M10,24h1v1h-1z M15,24h1v1h-1z M17,24h1v1h-1z M19,24h1v1h-1z M22,24h1v1h-1z M24,24h1v1h-1z" fill="#000000"></path>
     </svg>
    </p>
   </div>
   <p>To decode a PSK <code>P</code> given a QR code, follow these steps:</p>
   <ol>
    <li data-md>
     <p>Obtain the string <code>N</code> by decoding the QR code.</p>
    <li data-md>
     <p>Parse <code>N</code> as a hexadecimal number to obtain <code>P</code>.</p>
   </ol>
   <section class="informative">
    <h2 class="heading settled" id="appendix-c"><span class="content">Appendix C: Entire Flow Chart</span><a class="self-link" href="#appendix-c"></a></h2>
     <em>This section is non-normative.</em> 
    <p><img alt="Before a listening agent (client) and an advertising agent (server) may exchange application messages, they first need to discover each other through an mDNS exchange, establish a QUIC connection through ClientHello and ServerHello exchanges and sharing of certificates, and run an SPAKE2 authentication handshake and confirmation. They may also exchange messages to discover metadata at any time after a QUIC connection has been established." src="./images/entire_flow_chart.svg" style="width: 100%"></p>
   </section>
  </main>
  <div data-fill-with="conformance">
   <h2 class="no-ref no-num heading settled" id="w3c-conformance"><span class="content">Conformance</span><a class="self-link" href="#w3c-conformance"></a></h2>
   <h3 class="no-ref no-num heading settled" id="w3c-conventions"><span class="content">Document conventions</span><a class="self-link" href="#w3c-conventions"></a></h3>
   <p>Conformance requirements are expressed
    with a combination of descriptive assertions
    and RFC 2119 terminology.
    The key words “MUST”, “MUST NOT”, “REQUIRED”, “SHALL”, “SHALL NOT”, “SHOULD”, “SHOULD NOT”, “RECOMMENDED”, “MAY”, and “OPTIONAL”
    in the normative parts of this document
    are to be interpreted as described in RFC 2119.
    However, for readability,
    these words do not appear in all uppercase letters in this specification. </p>
   <p>All of the text of this specification is normative
    except sections explicitly marked as non-normative, examples, and notes. <a data-link-type="biblio" href="#biblio-rfc2119" title="Key words for use in RFCs to Indicate Requirement Levels">[RFC2119]</a> </p>
   <p>Examples in this specification are introduced with the words “for example”
    or are set apart from the normative text
    with <code>class="example"</code>,
    like this: </p>
   <div class="example" id="w3c-example">
    <a class="self-link" href="#w3c-example"></a> 
    <p>This is an example of an informative example. </p>
   </div>
   <p>Informative notes begin with the word “Note”
    and are set apart from the normative text
    with <code>class="note"</code>,
    like this: </p>
   <p class="note" role="note">Note, this is an informative note.</p>
   <section>
    <h3 class="no-ref no-num heading settled" id="w3c-conformant-algorithms"><span class="content">Conformant Algorithms</span><a class="self-link" href="#w3c-conformant-algorithms"></a></h3>
    <p>Requirements phrased in the imperative as part of algorithms
    (such as "strip any leading space characters"
    or "return false and abort these steps")
    are to be interpreted with the meaning of the key word
    ("must", "should", "may", etc)
    used in introducing the algorithm. </p>
    <p>Conformance requirements phrased as algorithms or specific steps
    can be implemented in any manner,
    so long as the end result is equivalent.
    In particular, the algorithms defined in this specification
    are intended to be easy to understand
    and are not intended to be performant.
    Implementers are encouraged to optimize. </p>
   </section>
  </div>
  <script src="https://www.w3.org/scripts/TR/2021/fixup.js"></script>
  <h2 class="no-num no-ref heading settled" id="index"><span class="content">Index</span><a class="self-link" href="#index"></a></h2>
  <h3 class="no-num no-ref heading settled" id="index-defined-here"><span class="content">Terms defined by this specification</span><a class="self-link" href="#index-defined-here"></a></h3>
  <ul class="index">
   <li><a href="#advertising-agent">advertising agent</a><span>, in § 3</span>
   <li><a href="#agent-certificate">agent certificate</a><span>, in § 4.2</span>
   <li><a href="#agent-fingerprint">agent fingerprint</a><span>, in § 3.1</span>
   <li><a href="#agent-hostname">agent hostname</a><span>, in § 3.3</span>
   <li><a href="#auth-capabilities">auth-capabilities</a><span>, in § Unnumbered section</span>
   <li><a href="#auth-initiation-token">auth-initiation-token</a><span>, in § Unnumbered section</span>
   <li><a href="#auth-spake2-confirmation">auth-spake2-confirmation</a><span>, in § Unnumbered section</span>
   <li><a href="#auth-spake2-handshake">auth-spake2-handshake</a><span>, in § Unnumbered section</span>
   <li><a href="#auth-status">auth-status</a><span>, in § Unnumbered section</span>
   <li><a href="#certificate-serial-number">certificate serial number</a><span>, in § 3.2</span>
   <li><a href="#certificate-serial-number-base">certificate serial number base</a><span>, in § 3.2</span>
   <li><a href="#certificate-serial-number-counter">certificate serial number counter</a><span>, in § 3.2</span>
   <li><a href="#display-name">display name</a><span>, in § 3</span>
   <li><a href="#listening-agent">listening agent</a><span>, in § 3</span>
   <li><a href="#open-screen-network-protocol-agent">open screen network protocol agent</a><span>, in § 1.1</span>
   <li><a href="#open-screen-network-protocol-agent">osp agent</a><span>, in § 1.1</span>
   <li><a href="#suspicious-agent">suspicious agent</a><span>, in § 7.3.2</span>
   <li><a href="#verified-display-name">verified display name</a><span>, in § 7.4.1</span>
  </ul>
  <h3 class="no-num no-ref heading settled" id="index-defined-elsewhere"><span class="content">Terms defined by reference</span><a class="self-link" href="#index-defined-elsewhere"></a></h3>
  <ul class="index">
   <li>
    <a data-link-type="biblio">[ISO18004]</a> defines the following terms:
    <ul>
     <li><span class="dfn-paneled" id="a2a5cd12">QR code</span>
    </ul>
   <li>
    <a data-link-type="biblio">[RFC4122]</a> defines the following terms:
    <ul>
     <li><span class="dfn-paneled" id="7da0b931">UUID</span>
    </ul>
   <li>
    <a data-link-type="biblio">[RFC5280]</a> defines the following terms:
    <ul>
     <li><span class="dfn-paneled" id="1653d24b">digitalSignature</span>
    </ul>
   <li>
    <a data-link-type="biblio">[RFC6762]</a> defines the following terms:
    <ul>
     <li><span class="dfn-paneled" id="56faf270">conflict resolution</span>
    </ul>
   <li>
    <a data-link-type="biblio">[RFC6763]</a> defines the following terms:
    <ul>
     <li><span class="dfn-paneled" id="1687f4bb">instance name</span>
     <li><span class="dfn-paneled" id="d7f13890">service instance name</span>
     <li><span class="dfn-paneled" id="5dec8682">service name</span>
    </ul>
   <li>
    <a data-link-type="biblio">[RFC8446]</a> defines the following terms:
    <ul>
     <li><span class="dfn-paneled" id="c7313446">signature scheme</span>
    </ul>
   <li>
    <a data-link-type="biblio">[RFC8610]</a> defines the following terms:
    <ul>
     <li><span class="dfn-paneled" id="87430c85">concise data definition language</span>
    </ul>
   <li>
    <a data-link-type="biblio">[RFC9000]</a> defines the following terms:
    <ul>
     <li><span class="dfn-paneled" id="a6ddbb58">CONNECTION_CLOSE Frames</span>
     <li><span class="dfn-paneled" id="d558f973">max_streams</span>
     <li><span class="dfn-paneled" id="6c09a22e">variable-length integer</span>
     <li><span class="dfn-paneled" id="4be354e2">Variable-Length Integer Encoding</span>
    </ul>
  </ul>
  <h2 class="no-num no-ref heading settled" id="references"><span class="content">References</span><a class="self-link" href="#references"></a></h2>
  <h3 class="no-num no-ref heading settled" id="normative"><span class="content">Normative References</span><a class="self-link" href="#normative"></a></h3>
  <dl>
   <dt id="biblio-iso18004">[ISO18004]
   <dd><a href="https://iso.org/standard/62021.html"><cite>Information technology — Automatic identification and data capture techniques — QR Code bar code symbology specification</cite></a>. Published. URL: <a href="https://iso.org/standard/62021.html">https://iso.org/standard/62021.html</a>
   <dt id="biblio-rfc2119">[RFC2119]
   <dd>S. Bradner. <a href="https://datatracker.ietf.org/doc/html/rfc2119"><cite>Key words for use in RFCs to Indicate Requirement Levels</cite></a>. March 1997. Best Current Practice. URL: <a href="https://datatracker.ietf.org/doc/html/rfc2119">https://datatracker.ietf.org/doc/html/rfc2119</a>
   <dt id="biblio-rfc4122">[RFC4122]
   <dd>P. Leach; M. Mealling; R. Salz. <a href="https://www.rfc-editor.org/rfc/rfc4122"><cite>A Universally Unique IDentifier (UUID) URN Namespace</cite></a>. July 2005. Proposed Standard. URL: <a href="https://www.rfc-editor.org/rfc/rfc4122">https://www.rfc-editor.org/rfc/rfc4122</a>
   <dt id="biblio-rfc4648">[RFC4648]
   <dd>S. Josefsson. <a href="https://www.rfc-editor.org/rfc/rfc4648"><cite>The Base16, Base32, and Base64 Data Encodings</cite></a>. October 2006. Proposed Standard. URL: <a href="https://www.rfc-editor.org/rfc/rfc4648">https://www.rfc-editor.org/rfc/rfc4648</a>
   <dt id="biblio-rfc5280">[RFC5280]
   <dd>D. Cooper; et al. <a href="https://www.rfc-editor.org/rfc/rfc5280"><cite>Internet X.509 Public Key Infrastructure Certificate and Certificate Revocation List (CRL) Profile</cite></a>. May 2008. Proposed Standard. URL: <a href="https://www.rfc-editor.org/rfc/rfc5280">https://www.rfc-editor.org/rfc/rfc5280</a>
   <dt id="biblio-rfc5480">[RFC5480]
   <dd>S. Turner; et al. <a href="https://www.rfc-editor.org/rfc/rfc5480"><cite>Elliptic Curve Cryptography Subject Public Key Information</cite></a>. March 2009. Proposed Standard. URL: <a href="https://www.rfc-editor.org/rfc/rfc5480">https://www.rfc-editor.org/rfc/rfc5480</a>
   <dt id="biblio-rfc5758">[RFC5758]
   <dd>Q. Dang; et al. <a href="https://www.rfc-editor.org/rfc/rfc5758"><cite>Internet X.509 Public Key Infrastructure: Additional Algorithms and Identifiers for DSA and ECDSA</cite></a>. January 2010. Proposed Standard. URL: <a href="https://www.rfc-editor.org/rfc/rfc5758">https://www.rfc-editor.org/rfc/rfc5758</a>
   <dt id="biblio-rfc6066">[RFC6066]
   <dd>D. Eastlake 3rd. <a href="https://www.rfc-editor.org/rfc/rfc6066"><cite>Transport Layer Security (TLS) Extensions: Extension Definitions</cite></a>. January 2011. Proposed Standard. URL: <a href="https://www.rfc-editor.org/rfc/rfc6066">https://www.rfc-editor.org/rfc/rfc6066</a>
   <dt id="biblio-rfc6762">[RFC6762]
   <dd>S. Cheshire; M. Krochmal. <a href="https://www.rfc-editor.org/rfc/rfc6762"><cite>Multicast DNS</cite></a>. February 2013. Proposed Standard. URL: <a href="https://www.rfc-editor.org/rfc/rfc6762">https://www.rfc-editor.org/rfc/rfc6762</a>
   <dt id="biblio-rfc6763">[RFC6763]
   <dd>S. Cheshire; M. Krochmal. <a href="https://www.rfc-editor.org/rfc/rfc6763"><cite>DNS-Based Service Discovery</cite></a>. February 2013. Proposed Standard. URL: <a href="https://www.rfc-editor.org/rfc/rfc6763">https://www.rfc-editor.org/rfc/rfc6763</a>
   <dt id="biblio-rfc7301">[RFC7301]
   <dd>S. Friedl; et al. <a href="https://www.rfc-editor.org/rfc/rfc7301"><cite>Transport Layer Security (TLS) Application-Layer Protocol Negotiation Extension</cite></a>. July 2014. Proposed Standard. URL: <a href="https://www.rfc-editor.org/rfc/rfc7301">https://www.rfc-editor.org/rfc/rfc7301</a>
   <dt id="biblio-rfc7469">[RFC7469]
   <dd>C. Evans; C. Palmer; R. Sleevi. <a href="https://www.rfc-editor.org/rfc/rfc7469"><cite>Public Key Pinning Extension for HTTP</cite></a>. April 2015. Proposed Standard. URL: <a href="https://www.rfc-editor.org/rfc/rfc7469">https://www.rfc-editor.org/rfc/rfc7469</a>
   <dt id="biblio-rfc7748">[RFC7748]
   <dd>A. Langley; M. Hamburg; S. Turner. <a href="https://www.rfc-editor.org/rfc/rfc7748"><cite>Elliptic Curves for Security</cite></a>. January 2016. Informational. URL: <a href="https://www.rfc-editor.org/rfc/rfc7748">https://www.rfc-editor.org/rfc/rfc7748</a>
   <dt id="biblio-rfc8446">[RFC8446]
   <dd>E. Rescorla. <a href="https://www.rfc-editor.org/rfc/rfc8446"><cite>The Transport Layer Security (TLS) Protocol Version 1.3</cite></a>. August 2018. Proposed Standard. URL: <a href="https://www.rfc-editor.org/rfc/rfc8446">https://www.rfc-editor.org/rfc/rfc8446</a>
   <dt id="biblio-rfc8610">[RFC8610]
   <dd>H. Birkholz; C. Vigano; C. Bormann. <a href="https://www.rfc-editor.org/rfc/rfc8610"><cite>Concise Data Definition Language (CDDL): A Notational Convention to Express Concise Binary Object Representation (CBOR) and JSON Data Structures</cite></a>. June 2019. Proposed Standard. URL: <a href="https://www.rfc-editor.org/rfc/rfc8610">https://www.rfc-editor.org/rfc/rfc8610</a>
   <dt id="biblio-rfc8949">[RFC8949]
   <dd>C. Bormann; P. Hoffman. <a href="https://www.rfc-editor.org/rfc/rfc8949"><cite>Concise Binary Object Representation (CBOR)</cite></a>. December 2020. Internet Standard. URL: <a href="https://www.rfc-editor.org/rfc/rfc8949">https://www.rfc-editor.org/rfc/rfc8949</a>
   <dt id="biblio-rfc9000">[RFC9000]
   <dd>J. Iyengar, Ed.; M. Thomson, Ed.. <a href="https://www.rfc-editor.org/rfc/rfc9000"><cite>QUIC: A UDP-Based Multiplexed and Secure Transport</cite></a>. May 2021. Proposed Standard. URL: <a href="https://www.rfc-editor.org/rfc/rfc9000">https://www.rfc-editor.org/rfc/rfc9000</a>
   <dt id="biblio-rfc9382">[RFC9382]
   <dd>W. Ladd. <a href="https://www.rfc-editor.org/rfc/rfc9382"><cite>SPAKE2, a Password-Authenticated Key Exchange</cite></a>. September 2023. Informational. URL: <a href="https://www.rfc-editor.org/rfc/rfc9382">https://www.rfc-editor.org/rfc/rfc9382</a>
   <dt id="biblio-x690">[X690]
   <dd><a href="https://www.itu.int/ITU-T/studygroups/com17/languages/X.690-0207.pdf"><cite>Recommendation X.690 — Information Technology — ASN.1 Encoding Rules — Specification of Basic Encoding Rules (BER), Canonical Encoding Rules (CER), and Distinguished Encoding Rules (DER)</cite></a>. URL: <a href="https://www.itu.int/ITU-T/studygroups/com17/languages/X.690-0207.pdf">https://www.itu.int/ITU-T/studygroups/com17/languages/X.690-0207.pdf</a>
  </dl>
  <h3 class="no-num no-ref heading settled" id="informative"><span class="content">Informative References</span><a class="self-link" href="#informative"></a></h3>
  <dl>
   <dt id="biblio-rfc2104">[RFC2104]
   <dd>H. Krawczyk; M. Bellare; R. Canetti. <a href="https://www.rfc-editor.org/rfc/rfc2104"><cite>HMAC: Keyed-Hashing for Message Authentication</cite></a>. February 1997. Informational. URL: <a href="https://www.rfc-editor.org/rfc/rfc2104">https://www.rfc-editor.org/rfc/rfc2104</a>
   <dt id="biblio-rfc5869">[RFC5869]
   <dd>H. Krawczyk; P. Eronen. <a href="https://www.rfc-editor.org/rfc/rfc5869"><cite>HMAC-based Extract-and-Expand Key Derivation Function (HKDF)</cite></a>. May 2010. Informational. URL: <a href="https://www.rfc-editor.org/rfc/rfc5869">https://www.rfc-editor.org/rfc/rfc5869</a>
   <dt id="biblio-rfc6234">[RFC6234]
   <dd>D. Eastlake 3rd; T. Hansen. <a href="https://www.rfc-editor.org/rfc/rfc6234"><cite>US Secure Hash Algorithms (SHA and SHA-based HMAC and HKDF)</cite></a>. May 2011. Informational. URL: <a href="https://www.rfc-editor.org/rfc/rfc6234">https://www.rfc-editor.org/rfc/rfc6234</a>
   <dt id="biblio-security-privacy-questionnaire">[SECURITY-PRIVACY-QUESTIONNAIRE]
   <dd>Theresa O'Connor; Peter Snyder; Simone Onofri. <a href="https://w3c.github.io/security-questionnaire/"><cite>Self-Review Questionnaire: Security and Privacy</cite></a>. URL: <a href="https://w3c.github.io/security-questionnaire/">https://w3c.github.io/security-questionnaire/</a>
  </dl>
  <h2 class="no-num no-ref heading settled" id="issues-index"><span class="content">Issues Index</span><a class="self-link" href="#issues-index"></a></h2>
  <div style="counter-reset:issue">
   <div class="issue"> Register ALPN with IANA. <a href="https://github.com/w3c/openscreenprotocol/issues/228">[Issue #228]</a> <a class="issue-return" href="#issue-808efb48" title="Jump to section">↵</a></div>
   <div class="issue"> [Meta] Track CFRG PAKE competition outcome <a href="https://github.com/w3c/openscreenprotocol/issues/242">[Issue #242]</a> <a class="issue-return" href="#issue-dc398825" title="Jump to section">↵</a></div>
   <div class="issue"> Rephrase to not link DNS-SD with an agent-info, an application
message. <a href="https://github.com/w3c/openscreenprotocol/issues/346">[Issue #346]</a> <a class="issue-return" href="#issue-40e518b1" title="Jump to section">↵</a></div>
  </div>
<script>/* Boilerplate: script-dom-helper */
"use strict";
function query(sel) { return document.querySelector(sel); }

function queryAll(sel) { return [...document.querySelectorAll(sel)]; }

function iter(obj) {
	if(!obj) return [];
	var it = obj[Symbol.iterator];
	if(it) return it;
	return Object.entries(obj);
}

function mk(tagname, attrs, ...children) {
	const el = document.createElement(tagname);
	for(const [k,v] of iter(attrs)) {
		if(k.slice(0,3) == "_on") {
			const eventName = k.slice(3);
			el.addEventListener(eventName, v);
		} else if(k[0] == "_") {
			// property, not attribute
			el[k.slice(1)] = v;
		} else {
			if(v === false || v == null) {
        continue;
      } else if(v === true) {
        el.setAttribute(k, "");
        continue;
      } else {
  			el.setAttribute(k, v);
      }
		}
	}
	append(el, children);
	return el;
}

/* Create shortcuts for every known HTML element */
[
  "a",
  "abbr",
  "acronym",
  "address",
  "applet",
  "area",
  "article",
  "aside",
  "audio",
  "b",
  "base",
  "basefont",
  "bdo",
  "big",
  "blockquote",
  "body",
  "br",
  "button",
  "canvas",
  "caption",
  "center",
  "cite",
  "code",
  "col",
  "colgroup",
  "datalist",
  "dd",
  "del",
  "details",
  "dfn",
  "dialog",
  "div",
  "dl",
  "dt",
  "em",
  "embed",
  "fieldset",
  "figcaption",
  "figure",
  "font",
  "footer",
  "form",
  "frame",
  "frameset",
  "head",
  "header",
  "h1",
  "h2",
  "h3",
  "h4",
  "h5",
  "h6",
  "hr",
  "html",
  "i",
  "iframe",
  "img",
  "input",
  "ins",
  "kbd",
  "label",
  "legend",
  "li",
  "link",
  "main",
  "map",
  "mark",
  "meta",
  "meter",
  "nav",
  "nobr",
  "noscript",
  "object",
  "ol",
  "optgroup",
  "option",
  "output",
  "p",
  "param",
  "pre",
  "progress",
  "q",
  "s",
  "samp",
  "script",
  "section",
  "select",
  "small",
  "source",
  "span",
  "strike",
  "strong",
  "style",
  "sub",
  "summary",
  "sup",
  "table",
  "tbody",
  "td",
  "template",
  "textarea",
  "tfoot",
  "th",
  "thead",
  "time",
  "title",
  "tr",
  "u",
  "ul",
  "var",
  "video",
  "wbr",
  "xmp",
].forEach(tagname=>{
	mk[tagname] = (...args) => mk(tagname, ...args);
});

function* nodesFromChildList(children) {
	for(const child of children.flat(Infinity)) {
		if(child instanceof Node) {
			yield child;
		} else {
			yield new Text(child);
		}
	}
}
function append(el, ...children) {
	for(const child of nodesFromChildList(children)) {
		if(el instanceof Node) el.appendChild(child);
		else el.push(child);
	}
	return el;
}

function insertAfter(el, ...children) {
	for(const child of nodesFromChildList(children)) {
		el.parentNode.insertBefore(child, el.nextSibling);
	}
	return el;
}

function clearContents(el) {
	el.innerHTML = "";
	return el;
}

function parseHTML(markup) {
	if(markup.toLowerCase().trim().indexOf('<!doctype') === 0) {
		const doc = document.implementation.createHTMLDocument("");
		doc.documentElement.innerHTML = markup;
		return doc;
	} else {
		const el = mk.template({});
		el.innerHTML = markup;
		return el.content;
	}
}</script>
<script>/* Boilerplate: script-dfn-panel */
"use strict";
{
let dfnPanelData = {
"1653d24b": {"dfnID":"1653d24b","dfnText":"digitalSignature","external":true,"refSections":[{"refs":[{"id":"ref-for-section-4.2.1.3"}],"title":"4.2. Agent Certificates"}],"url":"https://datatracker.ietf.org/doc/html/rfc5280#section-4.2.1.3"},
"1687f4bb": {"dfnID":"1687f4bb","dfnText":"instance name","external":true,"refSections":[{"refs":[{"id":"ref-for-section-4.1.1"}],"title":"3. Discovery with mDNS"},{"refs":[{"id":"ref-for-section-4.1.1\u2460"}],"title":"7.4.1. Instance and Display Names"}],"url":"https://datatracker.ietf.org/doc/html/rfc6763#section-4.1.1"},
"4be354e2": {"dfnID":"4be354e2","dfnText":"Variable-Length Integer Encoding","external":true,"refSections":[{"refs":[{"id":"ref-for-name-variable-length-integer-enc"}],"title":"3. Discovery with mDNS"},{"refs":[{"id":"ref-for-name-variable-length-integer-enc\u2460"},{"id":"ref-for-name-variable-length-integer-enc\u2461"}],"title":"5. Messages delivery using CBOR and QUIC streams"}],"url":"https://datatracker.ietf.org/doc/html/rfc9000#name-variable-length-integer-enc"},
"56faf270": {"dfnID":"56faf270","dfnText":"conflict resolution","external":true,"refSections":[{"refs":[{"id":"ref-for-section-9"}],"title":"3. Discovery with mDNS"}],"url":"https://datatracker.ietf.org/doc/html/rfc6762#section-9"},
"5dec8682": {"dfnID":"5dec8682","dfnText":"service name","external":true,"refSections":[{"refs":[{"id":"ref-for-section-7"}],"title":"3. Discovery with mDNS"}],"url":"https://datatracker.ietf.org/doc/html/rfc6763#section-7"},
"6c09a22e": {"dfnID":"6c09a22e","dfnText":"variable-length integer","external":true,"refSections":[{"refs":[{"id":"ref-for-name-variable-length-integer-enc"}],"title":"3. Discovery with mDNS"},{"refs":[{"id":"ref-for-name-variable-length-integer-enc\u2460"},{"id":"ref-for-name-variable-length-integer-enc\u2461"}],"title":"5. Messages delivery using CBOR and QUIC streams"}],"url":"https://datatracker.ietf.org/doc/html/rfc9000#name-variable-length-integer-enc"},
"7da0b931": {"dfnID":"7da0b931","dfnText":"UUID","external":true,"refSections":[{"refs":[{"id":"ref-for-section-4.4"}],"title":"3.2. Computing the Certificate Serial Number"}],"url":"https://datatracker.ietf.org/doc/html/rfc4122#section-4.4"},
"87430c85": {"dfnID":"87430c85","dfnText":"concise data definition language","external":true,"refSections":[{"refs":[{"id":"ref-for-section-3"}],"title":"Appendix A: Messages"}],"url":"https://datatracker.ietf.org/doc/html/rfc8610#section-3"},
"a2a5cd12": {"dfnID":"a2a5cd12","dfnText":"QR code","external":true,"refSections":[{"refs":[{"id":"ref-for-something"}],"title":"6. Authentication"},{"refs":[{"id":"ref-for-something\u2460"}],"title":"Appendix B: PSK Encoding Schemes"},{"refs":[{"id":"ref-for-something\u2461"}],"title":"QR Code"}],"url":"https://www.iso.org/standard/62021.html#"},
"a6ddbb58": {"dfnID":"a6ddbb58","dfnText":"CONNECTION_CLOSE Frames","external":true,"refSections":[{"refs":[{"id":"ref-for-name-connection_close-frames"}],"title":"5. Messages delivery using CBOR and QUIC streams"}],"url":"https://datatracker.ietf.org/doc/html/rfc9000#name-connection_close-frames"},
"advertising-agent": {"dfnID":"advertising-agent","dfnText":"advertising agent","external":false,"refSections":[{"refs":[{"id":"ref-for-advertising-agent"}],"title":"2.2. Non-Functional Requirements"},{"refs":[{"id":"ref-for-advertising-agent\u2460"}],"title":"4. Transport and metadata discovery with QUIC"},{"refs":[{"id":"ref-for-advertising-agent\u2461"}],"title":"4.2. Agent Certificates"},{"refs":[{"id":"ref-for-advertising-agent\u2462"}],"title":"6. Authentication"}],"url":"#advertising-agent"},
"agent-certificate": {"dfnID":"agent-certificate","dfnText":"agent\ncertificate","external":false,"refSections":[{"refs":[{"id":"ref-for-agent-certificate"}],"title":"3.1. Computing the Agent Fingerprint"},{"refs":[{"id":"ref-for-agent-certificate\u2460"}],"title":"4.1. TLS 1.3"},{"refs":[{"id":"ref-for-agent-certificate\u2461"},{"id":"ref-for-agent-certificate\u2462"},{"id":"ref-for-agent-certificate\u2463"},{"id":"ref-for-agent-certificate\u2464"}],"title":"4.2. Agent Certificates"}],"url":"#agent-certificate"},
"agent-fingerprint": {"dfnID":"agent-fingerprint","dfnText":"agent fingerprint","external":false,"refSections":[{"refs":[{"id":"ref-for-agent-fingerprint"}],"title":"3. Discovery with mDNS"},{"refs":[{"id":"ref-for-agent-fingerprint\u2460"}],"title":"4.1. TLS 1.3"},{"refs":[{"id":"ref-for-agent-fingerprint\u2461"}],"title":"6.1. Authentication with SPAKE2"}],"url":"#agent-fingerprint"},
"agent-hostname": {"dfnID":"agent-hostname","dfnText":"agent hostname","external":false,"refSections":[{"refs":[{"id":"ref-for-agent-hostname"}],"title":"3.3. Computing the Agent Hostname"},{"refs":[{"id":"ref-for-agent-hostname\u2460"}],"title":"4.1. TLS 1.3"},{"refs":[{"id":"ref-for-agent-hostname\u2461"}],"title":"4.2. Agent Certificates"}],"url":"#agent-hostname"},
"auth-capabilities": {"dfnID":"auth-capabilities","dfnText":"auth-capabilities","external":false,"refSections":[{"refs":[{"id":"ref-for-auth-capabilities"},{"id":"ref-for-auth-capabilities\u2460"}],"title":"6. Authentication"}],"url":"#auth-capabilities"},
"auth-initiation-token": {"dfnID":"auth-initiation-token","dfnText":"auth-initiation-token","external":false,"refSections":[{"refs":[{"id":"ref-for-auth-initiation-token"}],"title":"6. Authentication"}],"url":"#auth-initiation-token"},
"auth-spake2-confirmation": {"dfnID":"auth-spake2-confirmation","dfnText":"auth-spake2-confirmation","external":false,"refSections":[{"refs":[{"id":"ref-for-auth-spake2-confirmation"},{"id":"ref-for-auth-spake2-confirmation\u2460"},{"id":"ref-for-auth-spake2-confirmation\u2461"},{"id":"ref-for-auth-spake2-confirmation\u2462"}],"title":"6.1. Authentication with SPAKE2"}],"url":"#auth-spake2-confirmation"},
"auth-spake2-handshake": {"dfnID":"auth-spake2-handshake","dfnText":"auth-spake2-handshake","external":false,"refSections":[{"refs":[{"id":"ref-for-auth-spake2-handshake"},{"id":"ref-for-auth-spake2-handshake\u2460"},{"id":"ref-for-auth-spake2-handshake\u2461"},{"id":"ref-for-auth-spake2-handshake\u2462"},{"id":"ref-for-auth-spake2-handshake\u2463"},{"id":"ref-for-auth-spake2-handshake\u2464"},{"id":"ref-for-auth-spake2-handshake\u2465"},{"id":"ref-for-auth-spake2-handshake\u2466"},{"id":"ref-for-auth-spake2-handshake\u2467"}],"title":"6.1. Authentication with SPAKE2"}],"url":"#auth-spake2-handshake"},
"auth-status": {"dfnID":"auth-status","dfnText":"auth-status","external":false,"refSections":[{"refs":[{"id":"ref-for-auth-status"},{"id":"ref-for-auth-status\u2460"},{"id":"ref-for-auth-status\u2461"}],"title":"6.1. Authentication with SPAKE2"}],"url":"#auth-status"},
"c7313446": {"dfnID":"c7313446","dfnText":"signature scheme","external":true,"refSections":[{"refs":[{"id":"ref-for-section-4.2.3"}],"title":"4.2. Agent Certificates"}],"url":"https://datatracker.ietf.org/doc/html/rfc8446#section-4.2.3"},
"certificate-serial-number": {"dfnID":"certificate-serial-number","dfnText":"certificate serial number","external":false,"refSections":[{"refs":[{"id":"ref-for-certificate-serial-number"},{"id":"ref-for-certificate-serial-number\u2460"}],"title":"3.3. Computing the Agent Hostname"},{"refs":[{"id":"ref-for-certificate-serial-number\u2461"}],"title":"4.2. Agent Certificates"}],"url":"#certificate-serial-number"},
"certificate-serial-number-base": {"dfnID":"certificate-serial-number-base","dfnText":"certificate serial number base","external":false,"refSections":[{"refs":[{"id":"ref-for-certificate-serial-number-base"}],"title":"3.2. Computing the Certificate Serial Number"}],"url":"#certificate-serial-number-base"},
"certificate-serial-number-counter": {"dfnID":"certificate-serial-number-counter","dfnText":"certificate serial number counter","external":false,"refSections":[{"refs":[{"id":"ref-for-certificate-serial-number-counter"},{"id":"ref-for-certificate-serial-number-counter\u2460"}],"title":"3.2. Computing the Certificate Serial Number"}],"url":"#certificate-serial-number-counter"},
"d558f973": {"dfnID":"d558f973","dfnText":"max_streams","external":true,"refSections":[{"refs":[{"id":"ref-for-section-4.6"}],"title":"5. Messages delivery using CBOR and QUIC streams"}],"url":"https://datatracker.ietf.org/doc/html/rfc9000#section-4.6"},
"d7f13890": {"dfnID":"d7f13890","dfnText":"service instance name","external":true,"refSections":[{"refs":[{"id":"ref-for-section-4.1"}],"title":"3.3. Computing the Agent Hostname"}],"url":"https://datatracker.ietf.org/doc/html/rfc6763#section-4.1"},
"display-name": {"dfnID":"display-name","dfnText":"display\nname","external":false,"refSections":[],"url":"#display-name"},
"listening-agent": {"dfnID":"listening-agent","dfnText":"listening agent","external":false,"refSections":[{"refs":[{"id":"ref-for-listening-agent"}],"title":"2.2. Non-Functional Requirements"},{"refs":[{"id":"ref-for-listening-agent\u2460"}],"title":"4. Transport and metadata discovery with QUIC"},{"refs":[{"id":"ref-for-listening-agent\u2461"}],"title":"4.2. Agent Certificates"}],"url":"#listening-agent"},
"open-screen-network-protocol-agent": {"dfnID":"open-screen-network-protocol-agent","dfnText":"Open Screen Network\nProtocol agent","external":false,"refSections":[{"refs":[{"id":"ref-for-open-screen-network-protocol-agent"}],"title":"2.1. General Requirements"},{"refs":[{"id":"ref-for-open-screen-network-protocol-agent\u2460"}],"title":"3. Discovery with mDNS"},{"refs":[{"id":"ref-for-open-screen-network-protocol-agent\u2461"}],"title":"4.1. TLS 1.3"},{"refs":[{"id":"ref-for-open-screen-network-protocol-agent\u2462"}],"title":"5. Messages delivery using CBOR and QUIC streams"},{"refs":[{"id":"ref-for-open-screen-network-protocol-agent\u2463"}],"title":"6. Authentication"},{"refs":[{"id":"ref-for-open-screen-network-protocol-agent\u2464"}],"title":"7. Security and Privacy"}],"url":"#open-screen-network-protocol-agent"},
"suspicious-agent": {"dfnID":"suspicious-agent","dfnText":"suspicious\nagent","external":false,"refSections":[{"refs":[{"id":"ref-for-suspicious-agent"}],"title":"7.4. User Interface Considerations"}],"url":"#suspicious-agent"},
"verified-display-name": {"dfnID":"verified-display-name","dfnText":"verified\ndisplay name","external":false,"refSections":[{"refs":[{"id":"ref-for-verified-display-name"}],"title":"7.4.1. Instance and Display Names"}],"url":"#verified-display-name"},
};

document.addEventListener("DOMContentLoaded", ()=>{
    genAllDfnPanels();

    document.body.addEventListener("click", (e) => {
        // If not handled already, just hide all dfn panels.
        hideAllDfnPanels();
    });
});

window.addEventListener("resize", () => {
    // Pin any visible dfn panel
    queryAll(".dfn-panel.on, .dfn-panel.activated").forEach(el=>positionDfnPanel(el));
});

function genAllDfnPanels() {
    for(const panelData of Object.values(dfnPanelData)) {
        const dfnID = panelData.dfnID;
        const dfn = document.getElementById(dfnID);
        if(!dfn) {
            console.log(`Can't find dfn#${dfnID}.`, panelData);
            continue;
        }
        dfn.panelData = panelData;
        insertDfnPopupAction(dfn);
    }
}

function genDfnPanel(dfn, { dfnID, url, dfnText, refSections, external }) {
    const dfnPanel = mk.aside({
        class: "dfn-panel on",
        id: `infopanel-for-${dfnID}`,
        "data-for": dfnID,
        "aria-labelled-by":`infopaneltitle-for-${dfnID}`,
        },
        mk.span({id:`infopaneltitle-for-${dfnID}`, style:"display:none"},
            `Info about the '${dfnText}' ${external?"external":""} reference.`),
        mk.a({href:url, class:"dfn-link"}, url),
        refSections.length == 0 ? [] :
            mk.b({}, "Referenced in:"),
            mk.ul({},
                ...refSections.map(section=>
                    mk.li({},
                        ...section.refs.map((ref, refI)=>
                            [
                                mk.a({ href: `#${ref.id}` },
                                    (refI == 0) ? section.title : `(${refI + 1})`
                                ),
                                " ",
                            ]
                        ),
                    ),
                ),
            ),
        genLinkingSyntaxes(dfn),
    );

    dfnPanel.addEventListener('click', (event) => {
        if (event.target.nodeName == 'A') {
            scrollToTargetAndHighlight(event);
            pinDfnPanel(dfnPanel);
        }
        event.stopPropagation();
        refocusOnTarget(event);
    });
    dfnPanel.addEventListener('keydown', (event) => {
        if(event.keyCode == 27) { // Escape key
            hideDfnPanel({dfnPanel});
            event.stopPropagation();
            event.preventDefault();
        }
    });

    dfnPanel.dfn = dfn;
    dfn.dfnPanel = dfnPanel;
    return dfnPanel;
}



function hideAllDfnPanels() {
    // Delete the currently-active dfn panel.
    queryAll(".dfn-panel").forEach(dfnPanel=>hideDfnPanel({dfnPanel}));
}

function showDfnPanel(dfn) {
    hideAllDfnPanels(); // Only display one at a time.

    dfn.setAttribute("aria-expanded", "true");

    const dfnPanel = genDfnPanel(dfn, dfn.panelData);

    // Give the dfn a unique tabindex, and then
    // give all the tabbable panel bits successive indexes.
    let tabIndex = 100;
    dfn.tabIndex = tabIndex++;
    const tabbable = dfnPanel.querySelectorAll(":is(a, button)");
    for (const el of tabbable) {
        el.tabIndex = tabIndex++;
    }

    append(document.body, dfnPanel);
    positionDfnPanel(dfnPanel);
}

function positionDfnPanel(dfnPanel) {
    const dfn = dfnPanel.dfn;
    const dfnPos = getBounds(dfn);
    dfnPanel.style.top = dfnPos.bottom + "px";
    dfnPanel.style.left = dfnPos.left + "px";

    const panelPos = dfnPanel.getBoundingClientRect();
    const panelMargin = 8;
    const maxRight = document.body.parentNode.clientWidth - panelMargin;
    if (panelPos.right > maxRight) {
        const overflowAmount = panelPos.right - maxRight;
        const newLeft = Math.max(panelMargin, dfnPos.left - overflowAmount);
        dfnPanel.style.left = newLeft + "px";
    }
}

function pinDfnPanel(dfnPanel) {
    // Switch it to "activated" state, which pins it.
    dfnPanel.classList.add("activated");
    dfnPanel.style.position = "fixed";
    dfnPanel.style.left = null;
    dfnPanel.style.top = null;
}

function hideDfnPanel({dfn, dfnPanel}) {
    if(!dfnPanel) dfnPanel = dfn.dfnPanel;
    if(!dfn) dfn = dfnPanel.dfn;
    dfn.dfnPanel = undefined;
    dfnPanel.dfn = undefined;
    dfn.setAttribute("aria-expanded", "false");
    dfn.tabIndex = undefined;
    dfnPanel.remove()
}

function toggleDfnPanel(dfn) {
    if(dfn.dfnPanel) {
        hideDfnPanel(dfn);
    } else {
        showDfnPanel(dfn);
    }
}

function insertDfnPopupAction(dfn) {
    dfn.setAttribute('role', 'button');
    dfn.setAttribute('aria-expanded', 'false')
    dfn.tabIndex = 0;
    dfn.classList.add('has-dfn-panel');
    dfn.addEventListener('click', (event) => {
        toggleDfnPanel(dfn);
        event.stopPropagation();
    });
    dfn.addEventListener('keypress', (event) => {
        const kc = event.keyCode;
        // 32->Space, 13->Enter
        if(kc == 32 || kc == 13) {
            toggleDfnPanel(dfn);
            event.stopPropagation();
            event.preventDefault();
        }
    });
}

function refocusOnTarget(event) {
    const target = event.target;
    setTimeout(() => {
        // Refocus on the event.target element.
        // This is needed after browser scrolls to the destination.
        target.focus();
    });
}

// TODO: shared util
// Returns the root-level absolute position {left and top} of element.
function getBounds(el, relativeTo=document.body) {
    const relativeRect = relativeTo.getBoundingClientRect();
    const elRect = el.getBoundingClientRect();
    const top = elRect.top - relativeRect.top;
    const left = elRect.left - relativeRect.left;
    return {
        top,
        left,
        bottom: top + elRect.height,
        right: left + elRect.width,
    }
}

function scrollToTargetAndHighlight(event) {
    let hash = event.target.hash;
    if (hash) {
        hash = decodeURIComponent(hash.substring(1));
        const dest = document.getElementById(hash);
        if (dest) {
            dest.classList.add('highlighted');
            setTimeout(() => dest.classList.remove('highlighted'), 1000);
        }
    }
}

// Functions, divided by link type, that wrap an autolink's
// contents with the appropriate outer syntax.
// Alternately, a string naming another type they format
// the same as.
function needsFor(type) {
    switch(type) {
        case "descriptor":
        case "value":
        case "element-attr":
        case "attr-value":
        case "element-state":
        case "method":
        case "constructor":
        case "argument":
        case "attribute":
        case "const":
        case "dict-member":
        case "event":
        case "enum-value":
        case "stringifier":
        case "serializer":
        case "iterator":
        case "maplike":
        case "setlike":
        case "state":
        case "mode":
        case "context":
        case "facet": return true;

        default: return false;
    }
}
function refusesFor(type) {
    switch(type) {
        case "property":
        case "element":
        case "interface":
        case "namespace":
        case "callback":
        case "dictionary":
        case "enum":
        case "exception":
        case "typedef":
        case "http-header":
        case "permission": return true;

        default: return false;
    }
}
function linkFormatterFromType(type) {
    switch(type) {
        case 'scheme':
        case 'permission':
        case 'dfn': return (text) => `[=${text}=]`;

        case 'abstract-op': return (text) => `[\$${text}\$]`;

        case 'function':
        case 'at-rule':
        case 'selector':
        case 'value': return (text) => `''${text}''`;

        case 'http-header': return (text) => `[:${text}:]`;

        case 'interface':
        case 'constructor':
        case 'method':
        case 'argument':
        case 'attribute':
        case 'callback':
        case 'dictionary':
        case 'dict-member':
        case 'enum':
        case 'enum-value':
        case 'exception':
        case 'const':
        case 'typedef':
        case 'stringifier':
        case 'serializer':
        case 'iterator':
        case 'maplike':
        case 'setlike':
        case 'extended-attribute':
        case 'event':
        case 'idl': return (text) => `{{${text}}}`;

        case 'element-state':
        case 'element-attr':
        case 'attr-value':
        case 'element': return (element) => `<{${element}}>`;

        case 'grammar': return (text) => `${text} (within a <pre class=prod>)`;

        case 'type': return (text)=> `<<${text}>>`;

        case 'descriptor':
        case 'property': return (text) => `'${text}'`;

        default: return;
    };
};

function genLinkingSyntaxes(dfn) {
    if(dfn.tagName != "DFN") return;

    const type = dfn.getAttribute('data-dfn-type');
    if(!type) {
        console.log(`<dfn> doesn't have a data-dfn-type:`, dfn);
        return [];
    }

    // Return a function that wraps link text based on the type
    const linkFormatter = linkFormatterFromType(type);
    if(!linkFormatter) {
        console.log(`<dfn> has an unknown data-dfn-type:`, dfn);
        return [];
    }

    let ltAlts;
    if(dfn.hasAttribute('data-lt')) {
        ltAlts = dfn.getAttribute('data-lt')
            .split("|")
            .map(x=>x.trim());
    } else {
        ltAlts = [dfn.textContent.trim()];
    }
    if(type == "type") {
        // lt of "<foo>", but "foo" is the interior;
        // <<foo/bar>> is how you write it with a for,
        // not <foo/<bar>> or whatever.
        for(var i = 0; i < ltAlts.length; i++) {
            const lt = ltAlts[i];
            const match = /<(.*)>/.exec(lt);
            if(match) { ltAlts[i] = match[1]; }
        }
    }

    let forAlts;
    if(dfn.hasAttribute('data-dfn-for')) {
        forAlts = dfn.getAttribute('data-dfn-for')
            .split(",")
            .map(x=>x.trim());
    } else {
        forAlts = [''];
    }

    let linkingSyntaxes = [];
    if(!needsFor(type)) {
        for(const lt of ltAlts) {
            linkingSyntaxes.push(linkFormatter(lt));
        }
    }
    if(!refusesFor(type)) {
        for(const f of forAlts) {
            linkingSyntaxes.push(linkFormatter(`${f}/${ltAlts[0]}`))
        }
    }
    return [
        mk.b({}, 'Possible linking syntaxes:'),
        mk.ul({},
            ...linkingSyntaxes.map(link => {
                const copyLink = async () =>
                    await navigator.clipboard.writeText(link);
                return mk.li({},
                    mk.div({ class: 'link-item' },
                        mk.button({
                            class: 'copy-icon', title: 'Copy',
                            type: 'button',
                            _onclick: copyLink,
                            tabindex: 0,
                        }, mk.span({ class: 'icon' }) ),
                        mk.span({}, link)
                    )
                );
            })
        )
    ];
}
}
</script>
<script>/* Boilerplate: script-ref-hints */
"use strict";
{
let refsData = {
"#advertising-agent": {"displayText":"advertising agent","export":true,"for_":[],"level":"","normative":true,"shortname":"openscreen-network","spec":"openscreen-network","status":"local","text":"advertising agent","type":"dfn","url":"#advertising-agent"},
"#agent-certificate": {"displayText":"agent certificate","export":true,"for_":[],"level":"","normative":true,"shortname":"openscreen-network","spec":"openscreen-network","status":"local","text":"agent certificate","type":"dfn","url":"#agent-certificate"},
"#agent-fingerprint": {"displayText":"agent fingerprint","export":true,"for_":[],"level":"","normative":true,"shortname":"openscreen-network","spec":"openscreen-network","status":"local","text":"agent fingerprint","type":"dfn","url":"#agent-fingerprint"},
"#agent-hostname": {"displayText":"agent hostname","export":true,"for_":[],"level":"","normative":true,"shortname":"openscreen-network","spec":"openscreen-network","status":"local","text":"agent hostname","type":"dfn","url":"#agent-hostname"},
"#auth-capabilities": {"displayText":"auth-capabilities","export":true,"for_":[],"level":"","normative":true,"shortname":"openscreen-network","spec":"openscreen-network","status":"local","text":"auth-capabilities","type":"dfn","url":"#auth-capabilities"},
"#auth-initiation-token": {"displayText":"auth-initiation-token","export":true,"for_":[],"level":"","normative":true,"shortname":"openscreen-network","spec":"openscreen-network","status":"local","text":"auth-initiation-token","type":"dfn","url":"#auth-initiation-token"},
"#auth-spake2-confirmation": {"displayText":"auth-spake2-confirmation","export":true,"for_":[],"level":"","normative":true,"shortname":"openscreen-network","spec":"openscreen-network","status":"local","text":"auth-spake2-confirmation","type":"dfn","url":"#auth-spake2-confirmation"},
"#auth-spake2-handshake": {"displayText":"auth-spake2-handshake","export":true,"for_":[],"level":"","normative":true,"shortname":"openscreen-network","spec":"openscreen-network","status":"local","text":"auth-spake2-handshake","type":"dfn","url":"#auth-spake2-handshake"},
"#auth-status": {"displayText":"auth-status","export":true,"for_":[],"level":"","normative":true,"shortname":"openscreen-network","spec":"openscreen-network","status":"local","text":"auth-status","type":"dfn","url":"#auth-status"},
"#certificate-serial-number": {"displayText":"certificate serial number","export":true,"for_":[],"level":"","normative":true,"shortname":"openscreen-network","spec":"openscreen-network","status":"local","text":"certificate serial number","type":"dfn","url":"#certificate-serial-number"},
"#certificate-serial-number-base": {"displayText":"certificate serial number base","export":true,"for_":[],"level":"","normative":true,"shortname":"openscreen-network","spec":"openscreen-network","status":"local","text":"certificate serial number base","type":"dfn","url":"#certificate-serial-number-base"},
"#certificate-serial-number-counter": {"displayText":"certificate serial number counter","export":true,"for_":[],"level":"","normative":true,"shortname":"openscreen-network","spec":"openscreen-network","status":"local","text":"certificate serial number counter","type":"dfn","url":"#certificate-serial-number-counter"},
"#listening-agent": {"displayText":"listening agent","export":true,"for_":[],"level":"","normative":true,"shortname":"openscreen-network","spec":"openscreen-network","status":"local","text":"listening agent","type":"dfn","url":"#listening-agent"},
"#open-screen-network-protocol-agent": {"displayText":"open screen network protocol agent","export":true,"for_":[],"level":"","normative":true,"shortname":"openscreen-network","spec":"openscreen-network","status":"local","text":"open screen network protocol agent","type":"dfn","url":"#open-screen-network-protocol-agent"},
"#suspicious-agent": {"displayText":"suspicious agent","export":true,"for_":[],"level":"","normative":true,"shortname":"openscreen-network","spec":"openscreen-network","status":"local","text":"suspicious agent","type":"dfn","url":"#suspicious-agent"},
"#verified-display-name": {"displayText":"verified display name","export":true,"for_":[],"level":"","normative":true,"shortname":"openscreen-network","spec":"openscreen-network","status":"local","text":"verified display name","type":"dfn","url":"#verified-display-name"},
"09174256_https://datatracker.ietf.org/doc/html/rfc9000#name-variable-length-integer-enc": {"displayText":"Variable-Length Integer Encoding","export":true,"for_":[],"level":"","normative":true,"shortname":"rfc9000","spec":"rfc9000","status":"anchor-block","text":"variable-length integer encoding","type":"dfn","url":"https://datatracker.ietf.org/doc/html/rfc9000#name-variable-length-integer-enc"},
"https://datatracker.ietf.org/doc/html/rfc4122#section-4.4": {"displayText":"UUID","export":true,"for_":[],"level":"","normative":true,"shortname":"rfc4122","spec":"rfc4122","status":"anchor-block","text":"uuid","type":"dfn","url":"https://datatracker.ietf.org/doc/html/rfc4122#section-4.4"},
"https://datatracker.ietf.org/doc/html/rfc5280#section-4.2.1.3": {"displayText":"digitalSignature","export":true,"for_":[],"level":"","normative":true,"shortname":"rfc5280","spec":"rfc5280","status":"anchor-block","text":"digitalsignature","type":"dfn","url":"https://datatracker.ietf.org/doc/html/rfc5280#section-4.2.1.3"},
"https://datatracker.ietf.org/doc/html/rfc6762#section-9": {"displayText":"conflict resolution","export":true,"for_":[],"level":"","normative":true,"shortname":"rfc6762","spec":"rfc6762","status":"anchor-block","text":"conflict resolution","type":"dfn","url":"https://datatracker.ietf.org/doc/html/rfc6762#section-9"},
"https://datatracker.ietf.org/doc/html/rfc6763#section-4.1": {"displayText":"service instance name","export":true,"for_":[],"level":"","normative":true,"shortname":"rfc6763","spec":"rfc6763","status":"anchor-block","text":"service instance name","type":"dfn","url":"https://datatracker.ietf.org/doc/html/rfc6763#section-4.1"},
"https://datatracker.ietf.org/doc/html/rfc6763#section-4.1.1": {"displayText":"instance name","export":true,"for_":[],"level":"","normative":true,"shortname":"rfc6763","spec":"rfc6763","status":"anchor-block","text":"instance name","type":"dfn","url":"https://datatracker.ietf.org/doc/html/rfc6763#section-4.1.1"},
"https://datatracker.ietf.org/doc/html/rfc6763#section-7": {"displayText":"service name","export":true,"for_":[],"level":"","normative":true,"shortname":"rfc6763","spec":"rfc6763","status":"anchor-block","text":"service name","type":"dfn","url":"https://datatracker.ietf.org/doc/html/rfc6763#section-7"},
"https://datatracker.ietf.org/doc/html/rfc8446#section-4.2.3": {"displayText":"signature scheme","export":true,"for_":[],"level":"","normative":true,"shortname":"rfc8446","spec":"rfc8446","status":"anchor-block","text":"signature scheme","type":"dfn","url":"https://datatracker.ietf.org/doc/html/rfc8446#section-4.2.3"},
"https://datatracker.ietf.org/doc/html/rfc8610#section-3": {"displayText":"concise data definition language","export":true,"for_":[],"level":"","normative":true,"shortname":"rfc8610","spec":"rfc8610","status":"anchor-block","text":"concise data definition language","type":"dfn","url":"https://datatracker.ietf.org/doc/html/rfc8610#section-3"},
"https://datatracker.ietf.org/doc/html/rfc9000#name-connection_close-frames": {"displayText":"CONNECTION_CLOSE Frames","export":true,"for_":[],"level":"","normative":true,"shortname":"rfc9000","spec":"rfc9000","status":"anchor-block","text":"connection_close frames","type":"dfn","url":"https://datatracker.ietf.org/doc/html/rfc9000#name-connection_close-frames"},
"https://datatracker.ietf.org/doc/html/rfc9000#name-variable-length-integer-enc": {"displayText":"variable-length integer","export":true,"for_":[],"level":"","normative":true,"shortname":"rfc9000","spec":"rfc9000","status":"anchor-block","text":"variable-length integer","type":"dfn","url":"https://datatracker.ietf.org/doc/html/rfc9000#name-variable-length-integer-enc"},
"https://datatracker.ietf.org/doc/html/rfc9000#section-4.6": {"displayText":"max_streams","export":true,"for_":[],"level":"","normative":true,"shortname":"rfc9000","spec":"rfc9000","status":"anchor-block","text":"max_streams","type":"dfn","url":"https://datatracker.ietf.org/doc/html/rfc9000#section-4.6"},
"https://www.iso.org/standard/62021.html#": {"displayText":"QR code","export":true,"for_":[],"level":"","normative":true,"shortname":"iso18004","spec":"iso18004","status":"anchor-block","text":"qr code","type":"dfn","url":"https://www.iso.org/standard/62021.html#"},
};

function mkRefHint(link, ref) {
    const linkText = link.textContent;
    let dfnTextElements = '';
    if (ref.displayText.toLowerCase() != linkText.toLowerCase()) {
        // Give the original term if it's being displayed in a different way.
        // But allow casing differences, they're insignificant.
        dfnTextElements =
            mk.li({},
                mk.b({}, "Term: "),
                mk.span({}, ref.displayText)
            );
    }
    const forList = ref.for_;
    let forListElements;
    if(forList.length == 0) {
        forListElements = [];
    } else if(forList.length == 1) {
        forListElements = mk.li({},
            mk.b({}, "For: "),
            mk.span({}, forList[0]),
        );
    } else {
        forListElements = mk.li({},
            mk.b({}, "For: "),
            mk.ul({},
                ...forList.map(forItem =>
                    mk.li({},
                        mk.span({}, forItem)
                    ),
                ),
            ),
        );
    }
    const url = ref.url;
    const safeUrl = encodeURIComponent(url);
    const hintPanel = mk.aside({
        class: "ref-hint",
        id: `ref-hint-for-${safeUrl}`,
        "data-for": url,
        "aria-labelled-by": `ref-hint-for-${safeUrl}`,
    },
        mk.ul({},
            dfnTextElements,
            mk.li({},
                mk.b({}, "URL: "),
                mk.a({ href: url, class: "ref" }, url),
            ),
            mk.li({},
                mk.b({}, "Type: "),
                mk.span({}, `${ref.type}`),
            ),
            mk.li({},
                mk.b({}, "Spec: "),
                mk.span({}, `${ref.spec ? ref.spec : ''}`),
            ),
            forListElements
        ),
    );
    hintPanel.forLink = link;
    setupRefHintEventListeners(link, hintPanel);
    return hintPanel;
}

function hideAllRefHints() {
    queryAll(".ref-hint").forEach(el=>hideRefHint(el));
}

function hideRefHint(refHint) {
    const link = refHint.forLink;
    link.setAttribute("aria-expanded", "false");
    if(refHint.teardownEventListeners) {
        refHint.teardownEventListeners();
    }
    refHint.remove();
}

function showRefHint(link) {
    if(link.classList.contains("dfn-link")) return;
    const url = link.getAttribute("href");
    const refHintKey = link.getAttribute("data-refhint-key");
    let key = url;
    if(refHintKey) {
        key = refHintKey + "_" + url;
    }
    const ref = refsData[key];
    if(!ref) return;

    hideAllRefHints(); // Only display one at this time.

    const refHint = mkRefHint(link, ref);
    append(document.body, refHint);
    link.setAttribute("aria-expanded", "true");
    positionRefHint(refHint);
}

function setupRefHintEventListeners(link, refHint) {
    if (refHint.teardownEventListeners) return;
    // Add event handlers to hide the refHint after the user moves away
    // from both the link and refHint, if not hovering either within one second.
    let timeout = null;
    const startHidingRefHint = (event) => {
        if (timeout) {
            clearTimeout(timeout);
        }
        timeout = setTimeout(() => {
            hideRefHint(refHint);
        }, 1000);
    }
    const resetHidingRefHint = (event) => {
        if (timeout) clearTimeout(timeout);
        timeout = null;
    };
    link.addEventListener("mouseleave", startHidingRefHint);
    link.addEventListener("mouseenter", resetHidingRefHint);
    link.addEventListener("blur", startHidingRefHint);
    link.addEventListener("focus", resetHidingRefHint);
    refHint.addEventListener("mouseleave", startHidingRefHint);
    refHint.addEventListener("mouseenter", resetHidingRefHint);
    refHint.addEventListener("blur", startHidingRefHint);
    refHint.addEventListener("focus", resetHidingRefHint);

    refHint.teardownEventListeners = () => {
        // remove event listeners
        resetHidingRefHint();
        link.removeEventListener("mouseleave", startHidingRefHint);
        link.removeEventListener("mouseenter", resetHidingRefHint);
        link.removeEventListener("blur", startHidingRefHint);
        link.removeEventListener("focus", resetHidingRefHint);
        refHint.removeEventListener("mouseleave", startHidingRefHint);
        refHint.removeEventListener("mouseenter", resetHidingRefHint);
        refHint.removeEventListener("blur", startHidingRefHint);
        refHint.removeEventListener("focus", resetHidingRefHint);
    };
}

function positionRefHint(refHint) {
    const link = refHint.forLink;
    const linkPos = getBounds(link);
    refHint.style.top = linkPos.bottom + "px";
    refHint.style.left = linkPos.left + "px";

    const panelPos = refHint.getBoundingClientRect();
    const panelMargin = 8;
    const maxRight = document.body.parentNode.clientWidth - panelMargin;
    if (panelPos.right > maxRight) {
        const overflowAmount = panelPos.right - maxRight;
        const newLeft = Math.max(panelMargin, linkPos.left - overflowAmount);
        refHint.style.left = newLeft + "px";
    }
}

// TODO: shared util
// Returns the root-level absolute position {left and top} of element.
function getBounds(el, relativeTo=document.body) {
    const relativeRect = relativeTo.getBoundingClientRect();
    const elRect = el.getBoundingClientRect();
    const top = elRect.top - relativeRect.top;
    const left = elRect.left - relativeRect.left;
    return {
        top,
        left,
        bottom: top + elRect.height,
        right: left + elRect.width,
    }
}

function showRefHintListener(e) {
    // If the target isn't in a link (or is a link),
    // just ignore it.
    let link = e.target.closest("a");
    if(!link) return;

    // If the target is in a ref-hint panel
    // (aka a link in the already-open one),
    // also just ignore it.
    if(link.closest(".ref-hint")) return;

    // Otherwise, show the panel for the link.
    showRefHint(link);
}

function hideAllHintsListener(e) {
    // If the click is inside a ref-hint panel, ignore it.
    if(e.target.closest(".ref-hint")) return;
    // Otherwise, close all the current panels.
    hideAllRefHints();
}

document.addEventListener("DOMContentLoaded", () => {
    document.body.addEventListener("mousedown", showRefHintListener);
    document.body.addEventListener("focus", showRefHintListener);

    document.body.addEventListener("click", hideAllHintsListener);
});

window.addEventListener("resize", () => {
    // Hide any open ref hint.
    hideAllRefHints();
});
}
</script>